var Rt=Object.defineProperty;var Bt=(o,t,e)=>t in o?Rt(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var r=(o,t,e)=>Bt(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class Mt{constructor(t,e=Ot){r(this,"t",0);r(this,"start");r(this,"target");r(this,"speed");r(this,"active",!1);r(this,"interpolate");this.speed=t,this.interpolate=e}startLerp(t,e){this.start=t,this.target=e,this.t=0,this.active=!0}update(t){return this.active?(this.t+=t*this.speed,this.t>=1&&(this.t=1,this.active=!1),this.interpolate(this.start,this.target,this.t)):this.target}isActive(){return this.active}cancel(){this.active=!1,this.t=0}setSpeed(t){this.speed=t}}function Ft(o,t,e){const s=(t-o+Math.PI)%(Math.PI*2)-Math.PI;return o+s*e}function Et(o,t,e){return e<.5?o+(t-o)*(e*2):t+(o-t)*((e-.5)*2)}function Ot(o,t,e){return o+(t-o)*e}class _{static set(t){this.renderIF=t}static get(){return this.renderIF}}r(_,"renderIF");class z{constructor(t,e,s){r(this,"imageSrc");r(this,"frameWidth");r(this,"frameHeight");this.imageSrc=t,this.frameWidth=e,this.frameHeight=s}getSource(t,e){return{x:e*this.frameWidth,y:t*this.frameHeight,width:this.frameWidth,height:this.frameHeight}}draw(t,e,s,i,a){const n={imageSrc:this.imageSrc,source:this.getSource(t.row,t.col),world:{x:e.x,y:e.y,width:s,height:s},flip:i,angle:a};_.get().draw(n)}drawLine(t,e,s,i){const a=this.getSource(t.row,t.col);_.get().drawLine(this.imageSrc,e.x,e.y,s.x,s.y,i,a)}}class ct{constructor(t,e){r(this,"spriteSheet");r(this,"animation");r(this,"currentFrame",0);r(this,"timer",0);r(this,"done",!1);this.spriteSheet=t,this.animation=e}update(t){this.timer+=t;const e=this.animation.getFrameAmount(),s=1/this.animation.fps;if(this.timer>s){const i=Math.floor(this.timer/s),a=this.currentFrame+i;!this.animation.repeat&&a>e-1?(this.currentFrame=e-1,this.done=!0):(this.currentFrame=a%e,this.timer%=s)}}animationDone(){return this.done}getAnimation(){return this.animation}draw(t,e,s,i){const a=this.animation.getFrame(this.currentFrame);this.spriteSheet.draw(a,t,e,s,i)}setAnimation(t){this.done=!1,this.animation!==t&&(this.animation=t,this.currentFrame=0,this.timer=0)}reset(){this.timer=0,this.currentFrame=0}}class E{constructor(){r(this,"frames",[]);r(this,"fps",8);r(this,"repeat",!1)}addFrame(t){this.frames.push(t)}addSegment(t,e,s){if(t<e)for(let i=t;i<=e;i++){const a=i%s,n=Math.floor(i/s);this.frames.push({col:a,row:n})}else for(let i=t;i>=e;i--){const a=i%s,n=Math.floor(i/s);this.frames.push({col:a,row:n})}}addRow(t,e){for(let s=0;s<e;s++)this.frames.push({row:t,col:s})}getFrame(t){return this.frames[t]}getFrameAmount(){return this.frames.length}}class j{constructor(t=0,e=0){r(this,"row");r(this,"col");this.row=t,this.col=e}}class At{constructor(t){r(this,"currentState");r(this,"states",new Map);this.currentState=t}getIState(){return this.states.get(this.currentState)}getInstance(t){return this.states.get(t)}addState(t,e){this.states.set(t,e)}getCurrentState(){return this.currentState}forceState(t){this.changeState(t)}changeState(t){this.getIState().stateExited();const e=this.currentState;this.currentState=t,this.getIState().stateEntered(e)}enterState(t){this.getIState().stateEntered(t)}update(t,e=!1){const s=this.getIState();if(s.stateUpdate(t),e)return;const i=s.stateChange();i!==this.currentState&&this.changeState(i)}draw(){this.getIState().draw()}}class h{constructor(t=0,e=0){r(this,"x");r(this,"y");this.x=t,this.y=e}multiply(t){return t instanceof h?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*=t),this}divide(t){return t instanceof h?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/=t),this}add(t){return t instanceof h?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+=t),this}subtract(t){return t instanceof h?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-=t),this}clone(){return new h(this.x,this.y)}}var R=(o=>(o[o.Drop=0]="Drop",o[o.Upwards=1]="Upwards",o[o.Light=2]="Light",o[o.Hard=3]="Hard",o[o.HardDiagonal=4]="HardDiagonal",o))(R||{}),m=(o=>(o.Left="Left",o.Right="Right",o.Top="Top",o.Bot="Bot",o.TopLeft="TopLeft",o.TopRight="TopRight",o.BotLeft="BotLeft",o.BotRight="BotRight",o))(m||{}),D=(o=>(o.Left="left",o.Right="right",o))(D||{}),b=(o=>(o[o.Standard=0]="Standard",o[o.Slide=1]="Slide",o[o.Crouch=2]="Crouch",o[o.Flap=3]="Flap",o[o.Ragdoll=4]="Ragdoll",o))(b||{}),L=(o=>(o.Idle="idle",o.Walk="walk",o.Crouch="crouch",o.Flap="flap",o.Jump="jump",o.Fall="fall",o.Slide="slide",o.Turn="turn",o.ItemHolding="itemHolding",o.UpperRagdoll="upperRagdoll",o.LowerRagdoll="lowerRagdoll",o))(L||{}),B=(o=>(o[o.Up=0]="Up",o[o.Down=1]="Down",o[o.Left=2]="Left",o[o.Right=3]="Right",o[o.Flap=4]="Flap",o[o.Jump=5]="Jump",o[o.Activate=6]="Activate",o[o.ActivateHold=7]="ActivateHold",o[o.Hit=8]="Hit",o))(B||{}),p=(o=>(o[o.Hand=0]="Hand",o[o.Head=1]="Head",o[o.Body=2]="Body",o[o.Boots=3]="Boots",o[o.Back=4]="Back",o[o.Shield=5]="Shield",o))(p||{}),xt=(o=>(o[o.Damage=0]="Damage",o[o.Explosion=1]="Explosion",o[o.Poison=2]="Poison",o[o.Net=3]="Net",o))(xt||{});class jt{rotateForce(t,e){const s=Math.cos(e),i=Math.sin(e);return new h(t.x*s-t.y*i,t.x*i+t.y*s)}normalizeAngle(t){return(t+Math.PI)%(Math.PI*2)-Math.PI}}class Tt{getReverseDirection(t){switch(t){case m.Left:return m.Right;case m.Right:return m.Left;case m.Top:return m.Bot;case m.Bot:return m.Top;case m.TopLeft:return m.BotRight;case m.TopRight:return m.BotLeft;case m.BotLeft:return m.TopRight;case m.BotRight:return m.TopLeft}}}const Nt={player:{src:"/assets/player.png",frameWidth:32,frameHeight:32},playerHands:{src:"/assets/playerHands.png",frameWidth:16,frameHeight:16},tileIce:{src:"/assets/tileIce.png",frameWidth:16,frameHeight:16},shotgun:{src:"/assets/shotguns.png",frameWidth:32,frameHeight:32},glock:{src:"/assets/glock.png",frameWidth:20,frameHeight:20},armor:{src:"/assets/armor.png",frameWidth:16,frameHeight:16},grenade:{src:"/assets/grenade.png",frameWidth:16,frameHeight:16},trail:{src:"/assets/trail.png",frameWidth:8,frameHeight:1},explosion:{src:"/assets/explosion.png",frameWidth:64,frameHeight:64}},qt={images:Nt},zt=[{keyboard:{jump:" ",left:"a",right:"d",down:"s",up:"w",shoot:"ArrowLeft",pickup:"ArrowUp",ragdoll:"e",strafe:"l",menu:"esc"},controls:{}}],Jt={idle:{frames:[{row:0,col:0}]},walk:{row:1,frameCount:6,repeat:!0},crouch:{frames:[{row:2,col:0}]},flap:{row:3,frameCount:4,repeat:!0,fps:16},jump:{frames:[{row:4,col:0}]},fall:{frames:[{row:5,col:0}]},slide:{frames:[{row:6,col:0}]},turn:{frames:[{row:7,col:0}]},upperRagdoll:{frames:[{row:8,col:0}]},lowerRagdoll:{frames:[{row:9,col:0}]},itemHolding:{frames:[{row:8,col:0}]}},Ut={default:{frames:[{row:0,col:0}]},shoot:{frames:[{row:0,col:1},{row:0,col:1},{row:0,col:2},{row:0,col:3}],fps:24}},Wt={animation:{grid:{startRow:0,rowCount:3,startCol:0,colCount:4,exclude:1},fps:24}},Vt={player:Jt,glock:Ut,explosive:Wt},$t={gun:{row:0,col:0},handle:{row:1,col:0}},Xt={default:{row:0,col:0},pinned:{row:0,col:1}},Yt={default:{row:0,col:0}},Kt={default:{row:1,col:0},broken:{row:1,col:1}},Gt={default:{row:0,col:0},equipped:{row:0,col:1}},Qt={shotgun:$t,grenade:Xt,trail:Yt,helmet:Kt,chestplate:Gt},Zt={0:[5,0],1:[5,4],2:[4,0],3:[7,2],4:[6,1],5:[6,2],6:[6,3],7:[6,5],8:[4,5],9:[7,4],10:[4,4],11:[7,1],12:[6,4],13:[5,5],14:[4,2],15:[5,2],19:[3,2],23:[0,7],27:[3,1],31:[3,0],41:[3,4],43:[3,5],45:[1,7],47:[3,6],59:[3,3],63:[2,7],70:[0,2],71:[0,2],78:[0,2],79:[1,0],87:[2,2],95:[2,0],111:[6,5],127:[2,1],140:[0,4],141:[0,4],142:[1,6],143:[1,6],159:[3,0],173:[2,4],175:[2,6],191:[2,5],206:[0,3],207:[0,3],223:[1,2],239:[1,4],255:[1,3]},_t=[7,6],te=[7,7],ee={tileLookup:Zt,lipLeft:_t,lipRight:te},se=qt.images,ie=zt,oe=Vt,re=Qt,ae=ee,ne=se,vt=ie,he=oe,le=re,ce=ae;class de{getImage(t){return ne[t]}getControls(t){let e=Math.min(t,vt.length-1);return vt[e].keyboard}getTileLookup(){const t=ce,e={tiles:{},lipLeft:new j,lipRight:new j};for(const s in t.tileLookup)e.tiles[Number(s)]=new j(t.tileLookup[s][0],t.tileLookup[s][1]);return e.lipLeft.row=t.lipLeft[0],e.lipLeft.col=t.lipLeft[1],e.lipRight.row=t.lipRight[0],e.lipRight.col=t.lipRight[1],e}setFrames(t,e){const s=le[t];if(!s)throw new Error(t+" not found in config");for(const i in s){const a=e[i],n=s[i];if(!n)throw new Error(i+" not found in "+t+" frame record");a.col=n.col,a.row=n.row}}setAnimations(t,e){const s=he[t];if(!s)throw new Error(t+" not found in config");for(let i in s){const a=s[i],n=e[i];if(!n)throw new Error(i+" not found in "+t+" animation record");if(a.row&&a.frameCount&&n.addRow(a.row,a.frameCount),a.frames&&a.frames.forEach(l=>n.addFrame(l)),a.grid){const l=a.grid,c=[];for(let u=l.startRow;u<l.startRow+l.rowCount;u++)for(let f=l.startCol;f<l.startCol+l.colCount;f++)c.push({col:f,row:u});l.exclude&&c.splice(c.length-l.exclude),c.forEach(u=>n.addFrame(u))}a.repeat&&(n.repeat=a.repeat),a.fps&&(n.fps=a.fps)}}}class pe{getRandomArray(t){const e=Array.from({length:t},(s,i)=>i);for(let s=e.length-1;s>0;s--){const i=Math.floor(this.getRandomNumber(0,s+1));[e[s],e[i]]=[e[i],e[s]]}return e}getRandomSeed(){return Math.floor(Math.random()*4294967295)}getRandomNumber(t,e){return t+(e-t)*Math.random()}}class ue{getPointsAroundCircle(t,e,s){const i=[];for(let a=0;a<s;a++){const n=a*2*Math.PI/s,l=new h(t.x+Math.cos(n)*e,t.y+Math.sin(n)*e);i.push(l)}return i}randomOffsetVectorArray(t,e){for(const s of t.values())s.x+=Math.random()*e*(Math.random()<.5?-1:1),s.y+=Math.random()*e*(Math.random()<.5?-1:1)}convertNetwork(t){return new h(t.x,t.y)}}class d{}r(d,"Angle",new jt),r(d,"Direction",new Tt),r(d,"Random",new pe),r(d,"Vector",new ue),r(d,"File",new de);class ge{constructor(t){r(this,"state");this.state=t>>>0}next(){return this.state=1664525*this.state+1013904223>>>0,this.state/4294967296}getInRange(t,e){return t+(e-t)*this.next()}}const J={playerImage:"player",playerHands:"playerHands",tileIce:"tileIce",shotgun:"shotgun",glock:"glock",grenade:"grenade",armor:"armor",trail:"trail",explosion:"explosion"};class tt{static clear(){this.tiles=new Map}static getTile(t){return this.tiles.get(g.key(t))}static setTile(t){const e=g.getGridPos(t.body.pos);this.tiles.set(g.key(e),t),this.setNeighbours(t),t.update();for(const s of t.body.getNeighbours()){const i=this.getTile(this.shift(e,s));i.body.setNeighbour(d.Direction.getReverseDirection(s)),i.update()}}static getNearbyTiles(t,e,s,i){const a=[],n=Math.min(t.x,i.x),l=Math.max(t.x+e,i.x+e),c=Math.min(t.y,i.y),u=Math.max(t.y+s,i.y+s),f=g.size;for(let x=n-f;x<=l+f;x+=g.size)for(let T=c-f;T<=u+f;T+=g.size){const q=g.getGridPos(new h(x,T));this.processTile(q,a)}return a}static processTile(t,e){const s=this.getTile(t);if(!s)return;const i=s.body;if(e.push({gameObject:i,platform:i.isPlatform()}),s.body.getLip(D.Left)){const a=new et(i.pos.clone(),i.getLipWidth(),i.height);a.pos.x-=i.getLipWidth(),e.push({gameObject:a,platform:!0})}if(s.body.getLip(D.Right)){const a=new et(i.pos.clone(),i.getLipWidth(),i.height);a.pos.x+=i.width,e.push({gameObject:a,platform:!0})}}static tilesMatch(t,e){return t.constructor===e.constructor}static shift(t,e){switch(e){case m.Left:return new h(t.x-1,t.y);case m.Right:return new h(t.x+1,t.y);case m.Top:return new h(t.x,t.y-1);case m.Bot:return new h(t.x,t.y+1);case m.TopLeft:return new h(t.x-1,t.y-1);case m.TopRight:return new h(t.x+1,t.y-1);case m.BotLeft:return new h(t.x-1,t.y+1);case m.BotRight:return new h(t.x+1,t.y+1)}}static setNeighbours(t){const e=g.getGridPos(t.body.pos);for(const s of Object.values(m)){const i=this.tiles.get(g.key(this.shift(e,s)));i&&this.tilesMatch(t,i)?t.body.setNeighbour(s):t.body.removeNeighbour(s)}}static draw(){for(const t of this.tiles.values())t.draw()}}r(tt,"tiles",new Map);class et{constructor(t,e,s){r(this,"pos");r(this,"width");r(this,"height");this.pos=t,this.width=e,this.height=s}getCenter(){const t=this.pos.x+this.width/2,e=this.pos.y+this.height/2;return new h(t,e)}getPos(){return this.pos}getCorners(){return{TL:this.pos.clone(),BL:new h(this.pos.x,this.pos.y+this.height),TR:new h(this.pos.x+this.width,this.pos.y),BR:new h(this.pos.x+this.width,this.pos.y+this.height)}}setCenterToPos(t){this.pos.x=t.x-this.width/2,this.pos.y=t.y-this.height/2}collision(t){return this.pos.x<t.pos.x+t.width&&this.pos.x+this.width>t.pos.x&&this.pos.y<t.pos.y+t.height&&this.pos.y+this.height>t.pos.y}scale(t,e){const s=new h(this.pos.x-t/2,this.pos.y-e/2),i=this.width+t,a=this.height+e;return new et(s,i,a)}onBox(t){return t.x>=this.pos.x&&t.x<=this.pos.x+this.width&&t.y>=this.pos.y&&t.y<=this.pos.y+this.height}lineCollision(t,e){const s=e.clone().subtract(t);if(s.x===0&&t.x>=this.pos.x&&t.x<=this.pos.x+this.width){const F=Math.min(t.y,e.y),W=Math.max(t.y,e.y);if(W>=this.pos.y&&F<=this.pos.y+this.height){const it=W>this.pos.y+this.height?this.pos.y+this.height:this.pos.y;return{collision:!0,pos:new h(t.x,it)}}return{collision:!1,pos:this.pos}}if(s.y===0&&t.y>=this.pos.y&&t.y<=this.pos.y+this.height){const F=Math.min(t.x,e.x),W=Math.max(t.x,e.x);if(W>=this.pos.y&&F<=this.pos.y+this.height){const it=W>this.pos.x+this.width?this.pos.x+this.width:this.pos.x;return{collision:!0,pos:new h(it,t.y)}}return{collision:!1,pos:this.pos}}const i=s.y/s.x;let a=(this.pos.y-t.y)/i+t.x,n=(this.pos.y+this.height-t.y)/i+t.x;const l=new h(a,this.pos.y),c=new h(n,this.pos.y+this.height);let u=i*(this.pos.x-t.x)+t.y,f=i*(this.pos.x+this.width-t.x)+t.y;const x=new h(this.pos.x,u),T=new h(this.pos.x+this.width,f),q=[],X=F=>{this.onBox(F)&&(F.y-t.y)*Math.sign(s.y)>0&&q.push(F)},lt=F=>{this.onBox(F)&&(F.x-t.x)*Math.sign(s.x)>0&&q.push(F)};if(X(l),X(c),lt(x),lt(T),q.length===0)return{collision:!1,pos:this.pos};q.sort((F,W)=>{const it=Math.pow(t.x-F.x,2)+Math.pow(t.y-F.y,2),Ht=Math.pow(t.x-W.x,2)+Math.pow(t.y-W.y,2);return it-Ht});const st=q[0];return Math.pow(t.x-st.x,2)+Math.pow(t.y-st.y,2)>Math.pow(s.x,2)+Math.pow(s.y,2)?{collision:!1,pos:this.pos}:{collision:!0,pos:st}}}class ot extends et{constructor(e,s,i){super(e,s,i);r(this,"collidableObjects",[]);r(this,"grounded",!1);r(this,"collidingSide",!1);r(this,"collidingUp",!1);r(this,"friction",10);r(this,"frictionMultiplier",1);r(this,"ignoreFriction",!1);r(this,"velocity",new h);r(this,"gravity",1260);r(this,"ignoreGravity",!1);r(this,"ignorePlatforms",!1);r(this,"direction",D.Left);r(this,"bounceFactor",0);r(this,"smallestBounceValue",1)}getDirectionMultiplier(){return this.direction===D.Left?-1:1}isFlip(){return this.direction===D.Left}collided(){return this.grounded||this.collidingSide||this.collidingUp}update(e){this.velocityPhysicsUpdate(e);const s=this.pos.clone().add(this.velocity.clone().multiply(e));this.collidableObjects=tt.getNearbyTiles(this.pos,this.width,this.height,s),this.updatePositions(e)}velocityPhysicsUpdate(e){this.ignoreGravity||(this.velocity.y+=this.gravity*e),this.ignoreFriction||(this.velocity.x*=1/(1+e*this.friction*this.frictionMultiplier)),Math.abs(this.velocity.x)<.01&&(this.velocity.x=0)}updatePositions(e){this.pos.x=this.pos.x+this.velocity.x*e;const s=this.getHorizontalTileCollision();s&&this.handleSideCollision(s),this.pos.y=this.pos.y+this.velocity.y*e;const i=this.getVerticalTileCollision();i&&(this.velocity.y>0?this.handleBotCollision(i):this.handleTopCollision(i))}getHorizontalTileCollision(){this.collidingSide=!1;for(const e of this.collidableObjects)if(!(!this.collision(e.gameObject)||e.platform))return e.gameObject}getVerticalTileCollision(){this.grounded=!1,this.collidingUp=!1;for(const e of this.collidableObjects)if(this.collision(e.gameObject)){if(!e.platform)return e.gameObject;if(!(this.ignorePlatforms||this.velocity.y<0)&&!(this.pos.y+this.height>e.gameObject.pos.y+5+0))return e.gameObject}}handleSideCollision(e){this.collidingSide=!0,this.velocity.x>0?this.pos.x=e.pos.x-this.width:this.pos.x=e.pos.x+e.width,Math.abs(this.velocity.x)>this.smallestBounceValue?this.velocity.x*=-this.bounceFactor:this.velocity.x=0}handleTopCollision(e){this.pos.y=e.pos.y+e.height,this.collidingUp=!0,Math.abs(this.velocity.y)>this.smallestBounceValue?this.velocity.y*=-this.bounceFactor:this.velocity.y=0}handleBotCollision(e){this.pos.y=e.pos.y-this.height,this.grounded=!0,Math.abs(this.velocity.y)>this.smallestBounceValue?this.velocity.y*=-this.bounceFactor:this.velocity.y=0}getNearbyTiles(){return this.collidableObjects.map(e=>e.gameObject)}setNewCollidableObjects(){this.collidableObjects=tt.getNearbyTiles(this.pos,this.width,this.height,this.pos)}onPlatform(){return this.grounded?this.collidableObjects.every(e=>!this.collision(e.gameObject.scale(0,5))||e.platform):!1}}class fe extends et{constructor(e,s,i){super(e,s,s);r(this,"neighbours",new Set);r(this,"lipLeft",!1);r(this,"lipRight",!1);r(this,"platform",!1);this.platform=i}setLip(e,s){e===D.Left?this.lipLeft=s:this.lipRight=s}getLip(e){return e===D.Left?this.lipLeft:this.lipRight}getLipDrawPos(e){return e===D.Left?new h(this.pos.x-this.width,this.pos.y):new h(this.pos.x+this.width,this.pos.y)}getLipWidth(){return 8}isPlatform(){return this.platform}setNeighbour(e){this.neighbours.add(e)}removeNeighbour(e){this.neighbours.delete(e)}isNeighbour(e){return this.neighbours.has(e)}getNeighbours(){return this.neighbours}}class ye{constructor(){r(this,"drawSize",32);r(this,"pos",new h);r(this,"angle",0);r(this,"posOffset",new h);r(this,"rotateSpeed",25)}getCenter(){return new h(this.pos.x+this.drawSize/2,this.pos.y+this.drawSize/2)}setPosition(t,e,s,i){const a=t.clone();i?a.x+=e-this.drawSize-this.posOffset.x-s.x:a.x+=this.posOffset.x+s.x,a.y+=this.posOffset.y+s.y,this.pos=a}setOffset(t){this.posOffset=t.clone()}getOffset(){return this.posOffset}getDrawSize(){return this.drawSize}rotateArmUp(t){this.angle-=t*this.rotateSpeed,this.angle=Math.max(this.angle,-Math.PI/2)}rotateArmDown(t){this.angle+=t*this.rotateSpeed,this.angle=Math.min(this.angle,0)}}class w{static set(t){this.clients=t}static get(){return this.clients}}r(w,"clients");class Lt{constructor(){r(this,"subscribers");this.subscribers={}}subscribe(t,e){this.subscribers[t]||(this.subscribers[t]=new Set),this.subscribers[t].add(e)}unsubscribe(t,e){this.subscribers[t]&&this.subscribers[t].delete(e)}publish(t,e){if(this.subscribers[t])for(const s of this.subscribers[t].values())s(e)}}class dt{static set(t){this.current=t}static get(){return this.current}}r(dt,"current");var y=(o=>(o[o.ReadyToPlay=0]="ReadyToPlay",o[o.DataDone=1]="DataDone",o[o.PlayerInfo=2]="PlayerInfo",o[o.PlayerRagdollInfo=3]="PlayerRagdollInfo",o[o.NewPlayer=4]="NewPlayer",o[o.PlayerSpawn=5]="PlayerSpawn",o[o.PlayerHit=6]="PlayerHit",o[o.PlayerDead=7]="PlayerDead",o[o.PlayerEquipment=8]="PlayerEquipment",o[o.SpawnItem=9]="SpawnItem",o[o.DeleteItem=10]="DeleteItem",o[o.ActivateItem=11]="ActivateItem",o[o.DeactivateItem=12]="DeactivateItem",o[o.ThrowItem=13]="ThrowItem",o[o.SpawnProjectile=14]="SpawnProjectile",o[o.LoadMap=15]="LoadMap",o[o.ReadyForMap=16]="ReadyForMap",o[o.StartMap=17]="StartMap",o))(y||{});const at=class at{constructor(){r(this,"currentIndex",0);r(this,"idToObject",new Map);r(this,"objectToID",new Map)}static setBaseOffset(t){this.baseOffset=t}getNextID(){return at.baseOffset+this.currentIndex}reset(){this.currentIndex=0,this.idToObject.clear(),this.objectToID.clear()}add(t){const e=this.currentIndex+++at.baseOffset;return this.idToObject.set(e,t),this.objectToID.set(t,e),e}removeObject(t){const e=this.objectToID.get(t);if(e)return this.objectToID.delete(t),this.idToObject.delete(e),e}removeID(t){const e=this.idToObject.get(t);if(e)return this.objectToID.delete(e),this.idToObject.delete(t),e}setID(t,e){this.objectToID.set(t,e),this.idToObject.set(e,t)}getObject(t){return this.idToObject.get(t)}getID(t){return this.objectToID.get(t)}};r(at,"baseOffset",0);let nt=at;var U=(o=>(o[o.Knockback=0]="Knockback",o[o.Position=1]="Position",o[o.Aim=2]="Aim",o[o.Equip=3]="Equip",o))(U||{}),k=(o=>(o[o.Held=0]="Held",o[o.Equipped=1]="Equipped",o[o.None=2]="None",o))(k||{});class v{static update(t){this.items.forEach(e=>e.forEach(s=>{if(s.shouldBeDeleted()){e.delete(s);const i=this.idManager.removeObject(s);w.get().sendGameMessage(y.DeleteItem,{id:i})}else s.update(t)})),g.updateMapPositions(this.items,e=>e.getBody().pos)}static registerItem(t,e){this.register.set(t,e)}static create(t,e){const s=this.register.get(t);if(!s)return null;const i=new s(e);return this.addItem(i),this.idManager.setID(i,this.itemIndex++),i}static spawn(t,e,s){const i=this.register.get(t);if(!i)return;const a=new i(e);this.addItem(a),this.idManager.setID(a,s)}static getItems(t){return this.items.get(g.key(t))}static getNearby(t,e,s){const i=[],a=t.x-g.size*2,n=t.x+e+g.size*2,l=t.y-g.size*2,c=t.y+s+g.size*2;for(let u=a;u<n;u+=g.size)for(let f=l;f<c;f+=g.size){const x=g.getGridPos(new h(u,f));this.processItemArray(x,i)}return i}static processItemArray(t,e){const s=this.getItems(t);s&&s.forEach(i=>{i.getOwnership()===k.None&&e.push(i)})}static addItem(t){const e=t.getBody().pos;this.getItems(e)||this.items.set(g.key(e),new Set),this.getItems(e).add(t)}static getItemFromID(t){return this.idManager.getObject(t)}static getItemID(t){return this.idManager.getID(t)}static draw(){this.items.forEach(t=>t.forEach(e=>{e.getOwnership()===k.None&&e.draw()}))}}r(v,"items",new Map),r(v,"register",new Map),r(v,"idManager",new nt),r(v,"itemIndex",0);class me{constructor(t,e,s,i){r(this,"playerBody");r(this,"controls");r(this,"equipment");r(this,"nearbyItems",[]);r(this,"lastHeldItem",null);r(this,"forcedThrowType",null);r(this,"id");this.playerBody=t,this.controls=e,this.equipment=s,this.id=i}handle(){if(this.nearbyItems=v.getNearby(this.playerBody.pos,this.playerBody.width,this.playerBody.height),this.controls.pickup(C.Press)&&this.handlePickupOrThrow(),!this.equipment.hasItem(p.Hand))return;const t=this.equipment.getItem(p.Hand);this.handleInteractions(t)}handlePickupOrThrow(){if(this.equipment.hasItem(p.Hand)){const t=this.equipment.getItem(p.Hand),e=this.getThrowType();w.get().sendGameMessage(y.ThrowItem,{itemID:v.getItemID(t),pos:{x:t.getBody().pos.x,y:t.getBody().pos.y},direction:t.getBody().direction,throwType:e}),this.equipment.throw(p.Hand,e)}else{const t=this.getNearbyItem();t&&this.equipment.equip(t,p.Hand)}this.sendMessage()}sendMessage(){const t=[["holding",p.Hand],["head",p.Head],["body",p.Body],["boots",p.Boots]],e={id:this.id,holding:null,head:null,body:null,boots:null};t.forEach(([s,i])=>{this.equipment.hasItem(i)&&(e[s]=v.getItemID(this.equipment.getItem(i)))}),w.get().sendGameMessage(y.PlayerEquipment,e)}handleInteractions(t){[[()=>this.controls.shoot(C.Press),B.Activate],[()=>this.controls.up(C.Press),B.Up],[()=>this.controls.down(C.Press),B.Down],[()=>this.controls.left(C.Press),B.Left],[()=>this.controls.right(C.Press),B.Right]].forEach(([s,i])=>{if(!s())return;const a=t.interactions.get(i);if(!a)return;const n=d.Random.getRandomSeed();this.handleEffects(t,a(n,!0));const c={x:t.getBody().pos.x,y:t.getBody().pos.y},u=t.getAngle(),f=t.getBody().direction,x=v.getItemID(t);w.get().sendGameMessage(y.ActivateItem,{id:x,position:c,angle:u,action:i,direction:f,seed:n}),this.sendMessage()})}handleEffects(t,e){e.forEach(s=>{switch(s.type){case U.Aim:break;case U.Knockback:{this.playerBody.velocity.subtract(s.value);break}case U.Position:{this.playerBody.pos=s.value;break}case U.Equip:{this.equipment.equip(null,p.Hand),this.equipment.equip(t,s.value);break}}})}getNearbyItem(){let t=null;for(const e of this.nearbyItems)if(this.playerBody.collision(e.getBody().scale(30,30))){if(e===this.lastHeldItem){t=this.lastHeldItem;continue}return this.lastHeldItem=e,e}return t&&(this.lastHeldItem=t),t}getThrowType(){if(this.forcedThrowType!==null)return this.forcedThrowType;const t=this.controls.left(),e=this.controls.right(),s=this.controls.up();return this.controls.down()?R.Drop:t||e?s?R.HardDiagonal:R.Hard:s?R.Upwards:R.Light}}class we{constructor(t,e){r(this,"isJumping",!1);r(this,"jumpEnabled",!0);r(this,"minJump",350);r(this,"jumpForce",1200);r(this,"coyoteTime",new $(.15));r(this,"maxJumpTime",new $(.2));r(this,"playerCharacter");r(this,"controls");this.playerCharacter=t,this.controls=e}update(t){this.playerCharacter.grounded&&this.coyoteTime.reset(),this.jump(t)}jump(t){this.controls.jump(C.Press)&&this.jumpReady()&&this.jumpEnabled&&(this.isJumping=!0,this.playerCharacter.velocity.y=-this.minJump,this.maxJumpTime.reset(),this.coyoteTime.setToReady()),this.controls.jump()&&this.isJumping&&this.jumpEnabled&&(this.playerCharacter.velocity.y-=this.jumpForce*t,this.maxJumpTime.update(t)),(!this.controls.jump()||this.maxJumpTime.isDone())&&(this.isJumping=!1),this.coyoteTime.update(t)}getJumpRemaining(){return 1-this.maxJumpTime.getPercentageReady()}getJumpForce(){return this.jumpForce}jumpReady(){return!this.coyoteTime.isDone()&&!this.isJumping}}class be{constructor(t,e){r(this,"moveEnabled",!0);r(this,"movespeed",3e3);r(this,"playerCharacter");r(this,"controls");this.playerCharacter=t,this.controls=e}update(t){this.moveEnabled&&this.move(t)}move(t){const e=this.controls.left(),s=this.controls.right();e&&s?this.controls.left(C.Press)?this.playerCharacter.direction=D.Left:this.controls.right(C.Press)&&(this.playerCharacter.direction=D.Right):e?this.playerCharacter.direction=D.Left:s&&(this.playerCharacter.direction=D.Right),this.playerCharacter.velocity.x+=this.movespeed*this.controls.getMoveDirection()*t}willTurn(){const t=this.controls.left(C.Press)&&!this.playerCharacter.isFlip(),e=this.controls.right(C.Press)&&this.playerCharacter.isFlip();return(t||e)&&this.moveEnabled}}class Ce{constructor(t){r(this,"controls");this.controls=t}left(t=C.Hold){return t===C.Press?I.keyPress(this.controls.left):I.keyDown(this.controls.left)}right(t=C.Hold){return t===C.Press?I.keyPress(this.controls.right):I.keyDown(this.controls.right)}getMoveDirection(){return Number(this.right())-Number(this.left())}ragdoll(){return I.keyPress(this.controls.ragdoll)}down(t=C.Hold){return t===C.Press?I.keyPress(this.controls.down):I.keyDown(this.controls.down)}jump(t=C.Hold){return t===C.Press?I.keyPress(this.controls.jump):I.keyDown(this.controls.jump)}up(t=C.Hold){return t===C.Press?I.keyPress(this.controls.up):I.keyDown(this.controls.up)}shoot(t=C.Hold){return t===C.Press?I.keyPress(this.controls.shoot):I.keyDown(this.controls.shoot)}pickup(t=C.Hold){return t===C.Press?I.keyPress(this.controls.pickup):I.keyDown(this.controls.pickup)}}class xe{constructor(){r(this,"currAnim");r(this,"bodyAnimator");r(this,"armAnimator");r(this,"animations",{[L.Idle]:new E,[L.Walk]:new E,[L.Crouch]:new E,[L.Flap]:new E,[L.Jump]:new E,[L.Fall]:new E,[L.Slide]:new E,[L.Turn]:new E,[L.ItemHolding]:new E,[L.UpperRagdoll]:new E,[L.LowerRagdoll]:new E});r(this,"holding",!1);this.currAnim=L.Idle;const t=d.File.getImage(J.playerImage),e=new z(t.src,t.frameHeight,t.frameWidth);this.bodyAnimator=new ct(e,this.animations[this.currAnim]);const s=d.File.getImage(J.playerHands),i=new z(s.src,s.frameHeight,s.frameWidth);this.armAnimator=new ct(i,this.animations[this.currAnim]),d.File.setAnimations("player",this.animations)}setAnimation(t){this.currAnim=t,this.bodyAnimator.setAnimation(this.animations[this.currAnim]),this.holding?this.armAnimator.setAnimation(this.animations[L.ItemHolding]):this.armAnimator.setAnimation(this.animations[this.currAnim])}getCurrentAnimation(){return this.currAnim}drawBody(t,e,s){this.bodyAnimator.draw(t,e,s,0)}drawArm(t,e,s,i){this.armAnimator.draw(t,e,i,s)}drawRagdoll(t,e,s,i,a,n){this.bodyAnimator.setAnimation(this.animations.upperRagdoll),this.bodyAnimator.draw(t,s,n,i),this.bodyAnimator.setAnimation(this.animations.lowerRagdoll),this.bodyAnimator.draw(e,s,n,a)}update(t,e){this.bodyAnimator.update(t),this.armAnimator.update(t),this.holding=e}}class Ie{constructor(){r(this,"equipment",new Map)}hasItem(t){return this.equipment.get(t)!==void 0}getItem(t){return this.equipment.get(t)}equip(t,e){if(this.throw(e,R.Drop),!t)return;this.equipment.set(e,t);const s=e===p.Hand?k.Held:k.Equipped;this.getItem(e).setOwnership(s)}throw(t,e){if(!this.hasItem(t))return;const s=this.getItem(t);s.throw(e),s.setOwnership(k.None),this.equipment.set(t,void 0)}setBody(t,e,s,i,a){if(!this.hasItem(a))return;const n=this.getItem(a);n.getBody().setCenterToPos(t),n.getBody().direction=s,n.setWorldAngle(i);const l=d.Angle.rotateForce(e,i);n.getBody().pos.x+=l.x*n.getBody().getDirectionMultiplier(),n.getBody().pos.y+=l.y}getAllEquippedItems(){return this.equipment}drawItems(){const t=e=>{this.hasItem(e)&&this.getItem(e).draw()};t(p.Head),t(p.Body),t(p.Boots),t(p.Hand)}itemNoRotationCollision(t){if(!this.hasItem(p.Hand))return!1;const e=this.getItem(p.Hand),s=e.getBody().pos.clone();e.getBody().setCenterToPos(t),e.getBody().pos.x+=e.getHoldOffset().x*e.getBody().getDirectionMultiplier(),e.getBody().pos.y+=e.getHoldOffset().y;const i=e.getBody().getHorizontalTileCollision();return e.getBody().pos=s,i!==void 0}}class H{static update(t){this.updateMapPositions(t),this.trails.forEach(e=>{e.update(t),e.shouldBeDeleted()&&this.trails.delete(e)})}static updateMapPositions(t){this.projectiles.forEach(e=>e.forEach(s=>{if(s.getTrail().setTarget(s.getPos()),s.update(t),s.shouldBeDeleted()){e.delete(s),s.getTrail().setToDelete();return}})),g.updateMapPositions(this.projectiles,e=>e.getPos())}static registerProjectile(t,e){this.register.set(t,e)}static setProjectileID(t,e){this.projectileToID.set(t,e),this.IDToProjectile.set(e,t)}static create(t,e,s,i){const a=this.register.get(t);if(!a)return null;const n=new a(e,s);return this.addProjectile(n),this.setProjectileID(n,this.projectileIndex++),i&&n.setLocal(),n}static spawn(t,e,s,i){e=new h(e.x,e.y);const a=this.register.get(t);if(!a)return;const n=new a(e,s);this.addProjectile(n),this.setProjectileID(n,i)}static getProjectiles(t){return this.projectiles.get(g.key(t))}static addProjectile(t){const e=g.getGridPos(t.getPos());this.getProjectiles(e)||this.projectiles.set(g.key(e),new Set),this.getProjectiles(e).add(t),this.trails.add(t.getTrail())}static getProjectileFromID(t){return this.IDToProjectile.get(t)}static getProjectileID(t){return this.projectileToID.get(t)}static getNearbyProjectiles(t,e,s){const i=[],a=t.x-g.size*2,n=t.x+e+g.size*2,l=t.y-g.size*2,c=t.y+s+g.size*2;for(let u=a;u<n;u+=g.size)for(let f=l;f<c;f+=g.size){const x=g.getGridPos(new h(u,f));this.processProjectileSet(x,i)}return i}static processProjectileSet(t,e){const s=this.getProjectiles(t);s&&s.forEach(i=>{e.push(i)})}static draw(){this.trails.forEach(t=>{t.draw()}),this.projectiles.forEach(t=>t.forEach(e=>{e.draw()}))}}r(H,"projectiles",new Map),r(H,"IDToProjectile",new Map),r(H,"projectileToID",new Map),r(H,"trails",new Set),r(H,"register",new Map),r(H,"projectileIndex",0);const O=class O{constructor(t,e){r(this,"body");r(this,"animator");r(this,"armFront",new ye);r(this,"dead",!1);r(this,"controls");r(this,"jump");r(this,"movement");r(this,"equipment");r(this,"itemManager");r(this,"id");this.body=new ot(t,O.standardWidth,O.standardHeight),this.animator=new xe,this.equipment=new Ie,this.id=e}isLocal(){return this.controls!==void 0}setControls(t){this.controls=new Ce(t),this.movement=new be(this.body,this.controls),this.jump=new we(this.body,this.controls),this.itemManager=new me(this.body,this.controls,this.equipment,this.id)}setArmPos(){let t=new h;this.equipment.hasItem(p.Hand)&&(t=this.equipment.getItem(p.Hand).getHandOffset()),this.armFront.setPosition(this.getDrawPos(),O.drawSize,t,this.body.isFlip()),this.equipment.hasItem(p.Hand)&&this.equipment.setBody(this.armFront.getCenter(),this.equipment.getItem(p.Hand).getHoldOffset(),this.body.direction,this.armFront.angle,p.Hand)}setPos(t){this.body.pos=t,this.setArmPos(),this.body.setNewCollidableObjects()}updateControllers(t){this.body.collidingUp&&(this.jump.isJumping=!1),this.jump.update(t),this.movement.update(t),this.itemManager.handle()}nonLocalUpdate(t){this.animator.update(t,this.equipment.hasItem(p.Hand)),this.handleProjectileCollisions(t)}update(t){this.body.update(t),this.updateControllers(t),this.setArmPos(),this.animator.update(t,this.equipment.hasItem(p.Hand)),this.handleProjectileCollisions(t)}rotateArm(t,e=!1){this.movement.willTurn()&&(this.armFront.angle*=-1),e||this.armFront.angle>0||this.equipment.itemNoRotationCollision(this.armFront.getCenter())?this.armFront.rotateArmUp(t):this.armFront.rotateArmDown(t)}die(t=!0){this.dead=!0,t&&w.get().sendGameMessage(y.PlayerDead,{id:this.id})}isDead(){return this.dead}idleCollision(){const t=this.body.height,e=this.body.pos.y;this.body.height=O.standardHeight,this.body.pos.y-=O.standardHeight-t;const s=this.body.getHorizontalTileCollision();return this.body.pos.y=e,this.body.height=t,s!==void 0}handleProjectileCollisions(t){H.getNearbyProjectiles(this.body.pos,this.body.width,this.body.height).forEach(e=>{const s=d.Random.getRandomSeed();let i=null,a=null;if(this.equipment.getAllEquippedItems().forEach((n,l)=>{n&&e.willGoThrough(n.getBody(),t).collision&&(i=n,a=l)}),i||e.willGoThrough(this.body,t).collision){const n=e.onPlayerHit(s);e.isLocal()&&(w.get().sendGameMessage(y.PlayerHit,{id:this.id,effect:n,seed:s,slot:a}),this.handleEffect(n,i,s,!0))}})}handleEffect(t,e,s,i){switch(t){case xt.Damage:{e&&!e.shouldBeDeleted()&&e.interactions.get(B.Hit)?e.interactions.get(B.Hit)(s,i):this.die();break}}}getDrawPos(){const t=this.body.pos.x+(this.body.width-O.drawSize)/2,e=this.body.pos.y+(this.body.height-O.drawSize);return new h(t,e)}draw(){this.animator.drawBody(this.getDrawPos(),O.drawSize,this.body.isFlip()),this.equipment.drawItems(),this.animator.drawArm(this.armFront.pos,this.armFront.getDrawSize(),this.armFront.angle,this.body.isFlip())}};r(O,"drawSize",64),r(O,"standardHeight",46),r(O,"standardWidth",18);let A=O;class ve{constructor(t){r(this,"playerCharacter");r(this,"flapSpeed",90);this.playerCharacter=t}setCurrentAnimation(){this.playerCharacter.animator.setAnimation(L.Flap)}stateEntered(){const t=new h(10,28);this.playerCharacter.armFront.setOffset(t)}stateUpdate(t){if(!this.playerCharacter.isLocal()){this.nonLocalUpdate(t);return}this.playerCharacter.body.velocity.y=Math.min(this.playerCharacter.body.velocity.y,this.flapSpeed);const e=this.playerCharacter.equipment.hasItem(p.Hand);this.playerCharacter.rotateArm(t,e),this.playerCharacter.update(t),this.setCurrentAnimation(),this.setEquipmentPosition()}setEquipmentPosition(){const t=this.playerCharacter.body.getCenter();[[p.Head,new h(0,-21)],[p.Body,new h(2,1)],[p.Boots,new h(0,A.standardHeight/2)]].forEach(([s,i])=>{this.playerCharacter.equipment.setBody(t,i,this.playerCharacter.body.direction,0,s)})}stateChange(){const t=this.playerCharacter.controls;return t.ragdoll()||this.playerCharacter.isDead()?b.Ragdoll:t.down()?b.Crouch:t.jump()&&!this.playerCharacter.body.grounded?b.Flap:b.Standard}stateExited(){}nonLocalUpdate(t){this.playerCharacter.nonLocalUpdate(t),this.setEquipmentPosition()}draw(){this.playerCharacter.draw()}}class Le{constructor(t){r(this,"playerCharacter");r(this,"head");r(this,"body");r(this,"legs");r(this,"headAngle",0);r(this,"legsAngle",0);r(this,"height");r(this,"width");r(this,"coyoteTime",new $(.15));r(this,"owned",k.None);r(this,"interactions",new Map);this.playerCharacter=t,this.height=A.standardHeight/3,this.width=A.standardWidth,this.head=new ot(new h,this.width,this.height),this.legs=new ot(new h,this.width,this.height),this.body=new ot(new h,this.width,this.width);const e=.5;this.head.bounceFactor=e,this.body.bounceFactor=e,this.legs.bounceFactor=e,this.body.ignorePlatforms=!0;const s=8;this.head.friction=s,this.body.friction=s,this.legs.friction=s}handleInputs(t){}setAngle(t){const e=this.body.getCenter(),s=t?this.head.getCenter():this.legs.getCenter(),i=e.x-s.x,a=e.y-s.y,n=Math.atan2(a,i);t?this.headAngle=(n-Math.PI/2)*this.head.getDirectionMultiplier():this.legsAngle=(n+Math.PI/2)*this.legs.getDirectionMultiplier()}setBody(t,e,s){this.head.pos=t,this.body.pos=e,this.legs.pos=s}getBodies(){return{head:this.head.pos,body:this.body.pos,legs:this.legs.pos}}updateStandardBody(){const t=new h(this.legs.pos.x,this.legs.pos.y+this.legs.height-A.standardHeight);this.playerCharacter.body.grounded=!0,this.playerCharacter.setPos(t)}isGrounded(){return this.head.grounded||this.legs.grounded||this.body.grounded}keepBodiesTogether(t,e,s,i,a){const n=e.grounded,l=s.grounded,c=e.getCenter(),u=s.getCenter(),f=u.x-c.x,x=u.y-c.y,T=Math.hypot(f,x);if(a&&T>i)return;const q=(T-i)/T,X=new h(f*q,x*q).divide(2*t),lt=e.velocity.clone(),st=s.velocity.clone();e.velocity=X.clone(),s.velocity=X.clone().multiply(-1),e.updatePositions(t),s.updatePositions(t),e.grounded=n,s.grounded=l,e.velocity=lt.add(X),s.velocity=st.subtract(X)}stateEntered(t){this.playerCharacter.equipment.throw(p.Hand,R.Drop),this.playerCharacter.equipment.throw(p.Head,R.Drop),this.coyoteTime.setToReady(),this.head.direction=this.playerCharacter.body.direction,this.legs.direction=this.playerCharacter.body.direction;const e=this.playerCharacter.body.pos;if(t===b.Slide){const i=n=>new h(this.playerCharacter.body.getCenter().x+n*this.width/3,e.y+this.height),a=this.playerCharacter.body.getDirectionMultiplier();this.head.pos=i(-1*a),this.body.pos=i(0*a),this.legs.pos=i(1*a)}else this.head.pos=e.clone(),this.body.pos=e.clone().add(new h(0,this.height)),this.legs.pos=e.clone().add(new h(0,this.height*2));const s=this.playerCharacter.body.velocity;if(this.head.velocity=s.clone(),this.body.velocity=s.clone(),this.legs.velocity=s.clone(),this.playerCharacter.isLocal()&&this.playerCharacter.jump.isJumping){const i=this.playerCharacter.jump.getJumpRemaining(),a=this.playerCharacter.jump.getJumpForce()/5;this.body.velocity.y-=i*a,this.head.velocity.y-=i*a,this.legs.velocity.y-=i*a}this.headAngle=0,this.legsAngle=0}stateUpdate(t){if(!this.playerCharacter.isLocal()){this.nonLocalUpdate(t);return}this.coyoteTime.update(t),this.isGrounded()&&this.coyoteTime.reset(),this.head.ignoreFriction=!this.head.grounded,this.body.ignoreFriction=!this.body.grounded,this.legs.ignoreFriction=!this.legs.grounded,this.head.update(t),this.body.update(t),this.legs.update(t),this.keepBodiesTogether(t,this.head,this.body,this.height-1,!1),this.keepBodiesTogether(t,this.legs,this.body,this.height-1,!1),this.keepBodiesTogether(t,this.head,this.legs,this.height*1.5,!0),this.head.pos.x===this.legs.pos.x&&this.head.velocity.x===0&&this.legs.velocity.x===0&&(this.head.velocity.x=d.Random.getRandomNumber(-3,3)),this.playerCharacter.isDead()||this.handleInputs(t),this.setAngle(!0),this.setAngle(!1)}nonLocalUpdate(t){this.setAngle(!0),this.setAngle(!1)}stateChange(){return this.playerCharacter.isDead()?b.Ragdoll:(this.updateStandardBody(),(this.playerCharacter.controls.ragdoll()||this.playerCharacter.controls.jump(C.Press))&&!this.coyoteTime.isDone()?b.Standard:b.Ragdoll)}stateExited(){this.updateStandardBody();const t=25,e=-250;this.playerCharacter.body.pos.y-=t,this.playerCharacter.body.velocity=new h(this.body.velocity.x,e)}getDrawPos(t){const e=t.pos.x+(this.width-A.drawSize)/2,s=t.pos.y+(this.height-A.drawSize)/2;return new h(e,s)}draw(){this.playerCharacter.animator.drawRagdoll(this.getDrawPos(this.head),this.getDrawPos(this.legs),A.drawSize,this.headAngle,this.legsAngle,this.head.isFlip())}update(t){this.stateUpdate(t)}getBody(){return this.head}getAngle(){return this.headAngle}getLocalAngle(){return this.headAngle}setWorldAngle(t){this.headAngle=t}setLocalAngle(t){this.headAngle=t}getHandOffset(){return new h}getHoldOffset(){return new h}setOwnership(t){this.owned=t}getOwnership(){return this.owned}throw(t){this.owned=k.None}shouldBeDeleted(){return!1}setToDelete(){}}const Q=class Q{constructor(t,e){r(this,"playerCharacter");r(this,"platformIgnoreTime",new $(.15));r(this,"crouch");r(this,"unstuckSpeed",420);this.playerCharacter=t,this.crouch=e}stateEntered(){this.platformIgnoreTime.setToReady(),this.playerCharacter.isLocal()&&(this.playerCharacter.movement.moveEnabled=!1,this.playerCharacter.itemManager.forcedThrowType=R.Drop),this.playerCharacter.body.height=Q.SlideHeight,this.playerCharacter.body.pos.y+=A.standardHeight-this.playerCharacter.body.height;let t=new h(16,42);this.crouch&&(t=new h(10,34)),this.playerCharacter.armFront.setOffset(t)}stateUpdate(t){if(!this.playerCharacter.isLocal()){this.nonLocalUpdate(t);return}const e=this.crouch?L.Crouch:L.Slide;this.playerCharacter.animator.setAnimation(e),this.setFriction(),this.handlePlatforms(t),this.playerCharacter.rotateArm(t),this.playerCharacter.update(t),this.crouch?this.setEquipmentPositionsCrouch():this.setEquipmentPositionsSlide()}setEquipmentPositionsSlide(){const t=this.playerCharacter.body.getCenter();[[p.Head,new h(0,-20)],[p.Body,new h(0,2)],[p.Boots,new h(0,Q.SlideHeight)]].forEach(([s,i])=>{this.playerCharacter.equipment.setBody(t,i,this.playerCharacter.body.direction,-Math.PI/2,s)})}setEquipmentPositionsCrouch(){const t=this.playerCharacter.body.getCenter();[[p.Head,new h(0,-20)],[p.Body,new h(0,-4)],[p.Boots,new h(0,Q.SlideHeight)]].forEach(([s,i])=>{this.playerCharacter.equipment.setBody(t,i,this.playerCharacter.body.direction,0,s)})}setFriction(){this.playerCharacter.body.grounded?Math.abs(this.playerCharacter.body.velocity.x)>120?this.playerCharacter.body.frictionMultiplier=1/5:this.playerCharacter.body.frictionMultiplier=1:this.playerCharacter.body.frictionMultiplier=.5}handlePlatforms(t){this.playerCharacter.jump.jumpEnabled=!0,this.playerCharacter.controls.jump(C.Press)&&(this.platformIgnoreTime.reset(),this.playerCharacter.body.onPlatform()&&(this.playerCharacter.jump.jumpEnabled=!1),this.playerCharacter.body.grounded&&this.playerCharacter.idleCollision()&&(this.playerCharacter.body.velocity.x=this.unstuckSpeed*this.playerCharacter.body.getDirectionMultiplier(),this.playerCharacter.jump.jumpEnabled=!1)),this.playerCharacter.body.ignorePlatforms=!this.platformIgnoreTime.isDone(),this.platformIgnoreTime.update(t)}nonLocalUpdate(t){this.playerCharacter.nonLocalUpdate(t),this.crouch?this.setEquipmentPositionsCrouch():this.setEquipmentPositionsSlide()}stateChange(){return this.playerCharacter.controls.ragdoll()||this.playerCharacter.isDead()?b.Ragdoll:this.playerCharacter.controls.down()||this.playerCharacter.idleCollision()?this.crouch&&(!this.playerCharacter.body.grounded||Math.abs(this.playerCharacter.body.velocity.x)<180||this.playerCharacter.idleCollision())?b.Crouch:b.Slide:b.Standard}stateExited(){this.playerCharacter.body.pos.y-=A.standardHeight-this.playerCharacter.body.height,this.playerCharacter.body.height=A.standardHeight,this.platformIgnoreTime.reset(),this.playerCharacter.body.ignorePlatforms=!1,this.playerCharacter.isLocal()&&(this.playerCharacter.movement.moveEnabled=!0,this.playerCharacter.itemManager.forcedThrowType=null),this.playerCharacter.body.frictionMultiplier=1}draw(){this.playerCharacter.draw()}};r(Q,"SlideHeight",20);let pt=Q;class De{constructor(t){r(this,"playerCharacter");this.playerCharacter=t}setCurrentAnimation(){const t=this.playerCharacter.animator;if(!this.playerCharacter.body.grounded){this.playerCharacter.body.velocity.y<0?t.setAnimation(L.Jump):t.setAnimation(L.Fall);return}const e=this.playerCharacter.controls.left(),s=this.playerCharacter.controls.right();e&&this.playerCharacter.body.velocity.x>20||s&&this.playerCharacter.body.velocity.x<-20?t.setAnimation(L.Turn):Math.abs(this.playerCharacter.body.velocity.x)>20?t.setAnimation(L.Walk):t.setAnimation(L.Idle)}stateEntered(){const t=new h(10,28);this.playerCharacter.armFront.setOffset(t)}stateUpdate(t){if(!this.playerCharacter.isLocal()){this.nonLocalUpdate(t);return}this.playerCharacter.rotateArm(t),this.playerCharacter.update(t),this.setCurrentAnimation(),this.setEquipmentLocation()}setEquipmentLocation(){const t=this.playerCharacter.body.getCenter();[[p.Head,new h(0,-21)],[p.Body,new h(2,1)],[p.Boots,new h(0,A.standardHeight/2)]].forEach(([s,i])=>{this.playerCharacter.equipment.setBody(t,i,this.playerCharacter.body.direction,0,s)})}nonLocalUpdate(t){this.setEquipmentLocation(),this.playerCharacter.nonLocalUpdate(t)}stateChange(){return this.playerCharacter.controls.ragdoll()||this.playerCharacter.isDead()?b.Ragdoll:this.playerCharacter.controls.jump(C.Press)&&!this.playerCharacter.body.grounded&&!this.playerCharacter.jump.isJumping?b.Flap:this.playerCharacter.controls.down()?Math.abs(this.playerCharacter.body.velocity.x)<180||!this.playerCharacter.body.grounded?b.Crouch:b.Slide:b.Standard}stateExited(){}draw(){this.playerCharacter.draw()}}class Dt{constructor(t){r(this,"character");r(this,"stateMachine");this.stateMachine=new At(b.Standard),this.character=new A(new h,t),this.setupStateMachine()}setControls(t){this.character.setControls(t)}setupStateMachine(){this.stateMachine.addState(b.Standard,new De(this.character)),this.stateMachine.addState(b.Flap,new ve(this.character));const t=!0;this.stateMachine.addState(b.Crouch,new pt(this.character,t)),this.stateMachine.addState(b.Slide,new pt(this.character,!1)),this.stateMachine.addState(b.Ragdoll,new Le(this.character)),this.stateMachine.enterState()}setRagdoll(t,e,s){this.stateMachine.getInstance(b.Ragdoll).setBody(t,e,s)}getRagdoll(){return this.stateMachine.getInstance(b.Ragdoll).getBodies()}setState(t){t!==this.stateMachine.getCurrentState()&&this.stateMachine.forceState(t)}getCurrentState(){return this.stateMachine.getCurrentState()}update(t){this.character.isDead()&&this.stateMachine.getCurrentState()!==b.Ragdoll&&this.stateMachine.forceState(b.Ragdoll);const e=!this.character.isLocal();this.stateMachine.update(t,e)}draw(){this.character.body.getNearbyTiles().forEach(t=>{_.get().drawSquare({x:t.pos.x,y:t.pos.y,width:t.width,height:t.height},0,"green")}),this.stateMachine.draw()}}class P{static update(t){this.players.forEach(e=>e.forEach(s=>{s.update(t),s.character.equipment.getAllEquippedItems().forEach((i,a)=>{i&&i.shouldBeDeleted()&&s.character.equipment.equip(null,a)})})),g.updateMapPositions(this.players,e=>e.character.body.pos)}static getLocal(){const t=[];return this.players.forEach(e=>{e.forEach(s=>{s.character.isLocal()&&t.push(s)})}),t}static getPlayers(){const t=[];return this.players.forEach(e=>{e.forEach(s=>{t.push(s)})}),t}static create(){const t=new Dt(this.idManager.getNextID()),e=this.idManager.add(t);return this.addPlayer(t),t.setControls(d.File.getControls(this.localPlayerCount++)),w.get().sendGameMessage(y.NewPlayer,{id:e}),t}static spawn(t){const e=new Dt(t);return this.idManager.setID(e,t),this.addPlayer(e),e}static addPlayer(t){const e=g.key(new h);this.players.get(e)||this.players.set(e,new Set),this.players.get(e).add(t)}static draw(){this.players.forEach(t=>{t.forEach(e=>{e.draw()})})}static getPlayerFromID(t){return this.idManager.getObject(t)}static getPlayerID(t){return this.idManager.getID(t)}}r(P,"players",new Map),r(P,"idManager",new nt),r(P,"localPlayerCount",0);class Pe{constructor(){r(this,"tiles",[]);r(this,"playerSpawns",[]);r(this,"items",[])}setTile(t,e){const s=g.getWorldPos(e),i=new t(s,g.size);this.tiles.push(i)}getTiles(){return this.tiles}fillArea(t,e,s,i,a){for(let n=0;n<i;n++)for(let l=0;l<a;l++)this.setTile(t,new h(e+n,s+l))}setItem(t,e){this.items.push({type:t,gridPos:e})}getItems(){return this.items}setPlayerSpawn(t){const e=g.getWorldPos(t);e.y-=A.standardHeight,e.x-=A.standardWidth/2,this.playerSpawns.push(e)}getRandomSpawnLocations(t){const e=this.playerSpawns.length,s=Math.floor(t/e),i=t%e,a=d.Random.getRandomArray(e),n=new Array(t);let l=0;for(let c=0;c<e&&c<t;c++)for(let u=0;u<s;u++)n[l++]=this.playerSpawns[a[c]];for(let c=0;c<i;c++)n[l++]=this.playerSpawns[a[c]];return n}}class ut{static addMap(t,e){this.maps.set(t,e)}static getMap(t){return this.maps.get(t)}}r(ut,"maps",new Map);class Y{static init(){const t=w.get().gameEvent;t.subscribe(y.LoadMap,({name:e})=>{this.startNewMap(e)}),t.subscribe(y.ReadyForMap,()=>{this.readyCount++,this.checkReadyToStart()}),t.subscribe(y.StartMap,({time:e})=>{this.onStart(e)})}static quickStart(){P.create();const t=ut.getMap("defaultMap");this.loadMapTiles(t),this.hostInitializeMap(t),this.onStart(0)}static startNewMap(t){const e=ut.getMap(t);this.loadMapTiles(e),w.get().isHost()&&this.hostInitializeMap(e)}static loadMapTiles(t){t.getTiles().forEach(s=>tt.setTile(s))}static hostInitializeMap(t){this.readyCount=0,this.loadMapPlayerSpawns(t),this.loadMapItems(t),P.getPlayers().length===1&&this.onStart(Date.now()+500),w.get().sendGameMessage(y.DataDone,{})}static loadMapPlayerSpawns(t){const e=P.getPlayers(),s=t.getRandomSpawnLocations(e.length);for(let i=0;i<e.length;i++)e[i].character.setPos(s[i]),w.get().sendGameMessage(y.PlayerSpawn,{id:P.getPlayerID(e[i]),location:s[i]})}static loadMapItems(t){const e=t.getItems();for(const s of e){const i=g.getWorldPos(s.gridPos),a=v.create(s.type,i);if(!a)continue;a.getBody().pos.x+=(a.getBody().width-g.size)/2,a.getBody().pos.y+=a.getBody().height;const n=v.getItemID(a);w.get().sendGameMessage(y.SpawnItem,{id:n,type:s.type,location:a.getBody().pos})}}static checkReadyToStart(){const t=P.getPlayers().length;if(this.readyCount===t-1){this.readyCount=0;const e=Date.now()+500;w.get().sendGameMessage(y.StartMap,{time:e}),this.onStart(e)}}static setStart(t){this.onStart=t}}r(Y,"readyCount",0),r(Y,"onStart");class I{static init(){window.addEventListener("keydown",t=>{this.keysDown.has(t.key)||this.keysPressed.add(t.key);const e=t.target;this.keysDown.add(t.key),(t.key===" "||t.key==="ArrowLeft"||t.key==="ArrowUp")&&e.tagName!=="INPUT"&&e.tagName!=="TEXTAREA"&&t.preventDefault(),t.key==="q"&&this.quickStartAllowed&&(Y.quickStart(),this.quickStartAllowed=!1)}),window.addEventListener("keyup",t=>{this.keysDown.delete(t.key),this.keysPressed.delete(t.key)}),window.addEventListener("mousedown",t=>{this.mouseClickBool=!0,this.mouseDownBool=!0,this.mousePos=new h(t.clientX,t.clientY)}),window.addEventListener("mouseup",()=>{this.mouseDownBool=!1}),window.addEventListener("mousemove",t=>{this.mousePos=new h(t.clientX,t.clientY)})}static keyDown(t){return this.keysDown.has(t)}static keyPress(t){return this.keysPressed.has(t)}static mouseDown(){return this.mouseDownBool}static mouseClick(){return this.mouseClickBool}static getMousePos(){return this.mousePos}static update(){this.mouseClickBool=!1,this.keysPressed.clear()}}r(I,"keysDown",new Set),r(I,"keysPressed",new Set),r(I,"mouseClickBool",!1),r(I,"mouseDownBool",!1),r(I,"mousePos",new h),r(I,"quickStartAllowed",!0);var C=(o=>(o[o.Press=0]="Press",o[o.Hold=1]="Hold",o))(C||{});class g{static updateMapPositions(t,e){const s=new Map;for(const[i,a]of t.entries()){for(const n of a){const l=this.key(this.getGridPos(e(n)));i!==l&&(a.delete(n),s.has(l)||s.set(l,new Set),s.get(l).add(n))}a.size===0&&t.delete(i)}for(const[i,a]of s.entries()){t.has(i)||t.set(i,new Set);for(const n of a)t.get(i).add(n)}}static getGridPos(t){return new h(Math.floor(t.x/this.size),Math.floor(t.y/this.size))}static getWorldPos(t){return new h(t.x*this.size,t.y*this.size)}static key(t){return`${t.x},${t.y}`}}r(g,"size",32);class ${constructor(t){r(this,"timeCounted",0);r(this,"cooldownTime");this.cooldownTime=t}update(t){this.timeCounted+=t}isDone(){return this.timeCounted>=this.cooldownTime}reset(){this.timeCounted=0}setToReady(){this.timeCounted=this.cooldownTime}getPercentageReady(){return this.timeCounted/this.cooldownTime}}var gt=(o=>(o[o.lobby=0]="lobby",o[o.scoreScreen=1]="scoreScreen",o[o.postMatch=2]="postMatch",o[o.playing=3]="playing",o[o.editor=4]="editor",o))(gt||{});class ft{static update(t){for(const e of this.particles.values())e.update(t),e.shouldBeDeleted()&&this.particles.delete(e)}static draw(){for(const t of this.particles.values())t.draw()}static addParticle(t){this.particles.add(t)}}r(ft,"particles",new Set);class Pt{static update(t){let i=t,a=0;for(;i>0&&a<20;){const n=Math.min(.1,i);i-=n,this.gameUpdate(n),a++}}static gameUpdate(t){v.update(t),P.update(t),H.update(t),ft.update(t)}static draw(){H.draw(),v.draw(),P.draw(),ft.draw(),tt.draw()}}class Se{stateEntered(){}stateUpdate(t){Pt.update(t)}stateChange(){return gt.playing}stateExited(){}draw(){Pt.draw()}}var N=(o=>(o.forward="forward",o.connect="connect",o.joinLobby="joinLobby",o.leaveLobby="leaveLobby",o.hostLobby="hostLobby",o.startLobby="startLobby",o.listLobbies="listLobbies",o.listUsers="listUsers",o))(N||{}),M=(o=>(o.forwarded="forwarded",o.connected="connected",o.joinSuccess="joinSuccess",o.leaveSuccess="leaveSuccess",o.hostSuccess="hostSuccess",o.newHost="newHost",o.startGame="startGame",o.lobbyList="lobbyList",o.userList="userList",o.userJoined="userJoined",o.userLeft="userLeft",o))(M||{});class St{static init(){const t=w.get().gameEvent;t.subscribe(y.NewPlayer,({id:e})=>{P.spawn(e)}),t.subscribe(y.PlayerSpawn,({id:e,location:s})=>{P.getPlayerFromID(e).character.setPos(d.Vector.convertNetwork(s))}),t.subscribe(y.PlayerInfo,({id:e,pos:s,state:i,anim:a,side:n,armAngle:l})=>{const c=P.getPlayerFromID(e);i!==c.getCurrentState()&&c.setState(i),c.character.setPos(d.Vector.convertNetwork(s)),c.character.body.direction=n,c.character.animator.setAnimation(a),c.character.armFront.angle=l}),t.subscribe(y.PlayerHit,({id:e,effect:s,slot:i,seed:a})=>{const n=P.getPlayerFromID(e);let l=null;i&&n.character.equipment.hasItem(i)&&(l=n.character.equipment.getItem(i)),n.character.handleEffect(s,l,a,!1)}),t.subscribe(y.PlayerEquipment,({id:e,holding:s,head:i,body:a,boots:n})=>{const l=P.getPlayerFromID(e);[[s,p.Hand],[i,p.Head],[a,p.Body],[n,p.Boots]].forEach(([u,f])=>{u!==null&&v.getItemFromID(u)?l.character.equipment.equip(v.getItemFromID(u),f):l.character.equipment.equip(null,f)})}),t.subscribe(y.PlayerDead,({id:e})=>{P.getPlayerFromID(e).character.die(!1)}),t.subscribe(y.PlayerRagdollInfo,({id:e,head:s,legs:i,body:a})=>{const n=P.getPlayerFromID(e);n.getCurrentState()!==b.Ragdoll&&n.setState(b.Ragdoll),n.setRagdoll(d.Vector.convertNetwork(s),d.Vector.convertNetwork(a),d.Vector.convertNetwork(i))})}static sendLocalPlayersInfo(){P.getLocal().forEach(t=>{const e=P.getPlayerID(t);if(t.getCurrentState()===b.Ragdoll){const s=t.getRagdoll();w.get().sendGameMessage(y.PlayerRagdollInfo,{id:e,head:{x:s.head.x,y:s.head.y},body:{x:s.body.x,y:s.body.y},legs:{x:s.legs.x,y:s.legs.y}})}else w.get().sendGameMessage(y.PlayerInfo,{id:e,pos:t.character.body.pos,state:t.getCurrentState(),anim:t.character.animator.getCurrentAnimation(),side:t.character.body.direction,armAngle:t.character.armFront.angle})})}}class Me{static init(){const t=w.get().gameEvent;t.subscribe(y.SpawnItem,({type:e,id:s,location:i})=>{v.spawn(e,d.Vector.convertNetwork(i),s)}),t.subscribe(y.DeleteItem,({id:e})=>{const s=v.getItemFromID(e);s&&s.setToDelete()}),t.subscribe(y.ActivateItem,({id:e,position:s,angle:i,direction:a,action:n,seed:l})=>{const c=v.getItemFromID(e);if(!c)return;c.setWorldAngle(i),c.getBody().pos=d.Vector.convertNetwork(s),c.getBody().direction=a,c.interactions.get(n)(l,!1).forEach(x=>{switch(x.type){case U.Aim:break}})}),t.subscribe(y.ThrowItem,({itemID:e,pos:s,direction:i,throwType:a})=>{const n=v.getItemFromID(e);n&&(P.getPlayers().forEach(l=>{l.character.equipment.getAllEquippedItems().forEach((c,u)=>{l.character.equipment.getItem(u)===n&&l.character.equipment.equip(null,u)})}),n.getBody().pos=d.Vector.convertNetwork(s),n.getBody().direction=i,n.throw(a))})}}class Ae{static init(){w.get().gameEvent.subscribe(y.SpawnProjectile,({type:e,id:s,location:i,angle:a})=>{H.spawn(e,d.Vector.convertNetwork(i),a,s)})}}class rt{static init(){St.init(),Me.init(),Y.init(),Ae.init(),w.get().serverEvent.subscribe(M.startGame,({userID:e})=>{nt.setBaseOffset(e*(2<<16)),P.create(),w.get().sendGameMessage(y.ReadyToPlay,{}),w.get().connectionCount()===0&&Y.startNewMap("defaultMap")});const t=w.get().gameEvent;t.subscribe(y.ReadyToPlay,()=>{if(this.readyCount++,w.get().isHost()&&this.readyCount===w.get().connectionCount()){this.readyCount=0;const e="defaultMap";Y.startNewMap(e),w.get().sendGameMessage(y.LoadMap,{name:e})}}),t.subscribe(y.DataDone,()=>{w.get().sendGameMessage(y.ReadyForMap,{})})}static onMapLoad(t){Y.setStart(t)}static update(t){this.messageTimer.update(t),this.messageTimer.isDone()&&(St.sendLocalPlayersInfo(),this.messageTimer.reset())}}r(rt,"readyCount",0),r(rt,"messageTimer",new $(.05));class ke{constructor(){r(this,"lastTime",0);r(this,"stateMachine");r(this,"gameLoop",t=>{const e=(t-this.lastTime)/1e3;this.lastTime=t,_.get().clear(),this.stateMachine.update(e),this.stateMachine.draw(),I.update(),rt.update(e),requestAnimationFrame(this.gameLoop)});rt.init(),dt.get().show();const t=gt.playing;this.stateMachine=new At(t),this.stateMachine.addState(gt.playing,new Se),rt.onMapLoad(e=>{this.startGame(e)})}startGame(t){setTimeout(()=>{dt.get().hide(),requestAnimationFrame(this.gameLoop)},Math.max(t-Date.now(),0))}}class He{constructor(){r(this,"hostmenu");r(this,"cancelbutton");r(this,"createbutton");r(this,"nameInput");r(this,"maxPlayersInput");this.hostmenu=document.getElementById("hostMenu"),this.cancelbutton=document.getElementById("cancelHostbutton"),this.createbutton=document.getElementById("createLobbybutton"),this.nameInput=document.getElementById("lobbyNameInput"),this.maxPlayersInput=document.getElementById("maxPlayersInput"),this.createbutton.disabled=!0,this.nameInput.addEventListener("input",()=>this.validateInputs()),this.maxPlayersInput.addEventListener("input",()=>this.validateInputs()),this.cancelbutton.addEventListener("click",()=>{this.hide(),this.nameInput.value="",this.maxPlayersInput.value="4"}),this.createbutton.addEventListener("click",()=>{const t=this.nameInput.value.trim(),e=parseInt(this.maxPlayersInput.value);console.log("Creating lobby:",t,e),this.hide();const s={type:N.hostLobby,lobbySize:e,lobbyName:this.nameInput.value};w.get().sendClientMessage(s),this.nameInput.value="",this.maxPlayersInput.value="4"})}validateInputs(){const t=this.nameInput.value.trim(),e=parseInt(this.maxPlayersInput.value),s=this.isValidLobbyName(t)&&this.isValidMaxPlayers(e);this.createbutton.disabled=!s}isValidLobbyName(t){return t.length>=3&&t.length<=20}isValidMaxPlayers(t){return!isNaN(t)&&t>=2&&t<=16}hide(){this.hostmenu.classList.add("hidden")}show(){this.hostmenu.classList.remove("hidden")}}class Re{constructor(){r(this,"mainDiv");r(this,"lobbyDiv");r(this,"selectedLobbyId",null);r(this,"hostMenu",new He);r(this,"joinbutton");r(this,"hostbutton");r(this,"startbutton");r(this,"leavebutton");r(this,"lastLobbies",[]);r(this,"connectedLobby",null);r(this,"hosting",!1);this.mainDiv=document.getElementById("gameServerList"),this.lobbyDiv=document.getElementById("lobbylist"),this.startbutton=document.getElementById("startbutton"),this.startbutton.addEventListener("click",()=>this.onStart()),this.leavebutton=document.getElementById("leavebutton"),this.leavebutton.addEventListener("click",()=>this.onLeave()),this.joinbutton=document.getElementById("joinbutton"),this.joinbutton.addEventListener("click",()=>this.onJoin()),this.hostbutton=document.getElementById("hostbutton"),this.hostbutton.addEventListener("click",()=>this.onHost()),this.startbutton.disabled=!0,this.leavebutton.disabled=!0,this.joinbutton.disabled=!0;const t=w.get().serverEvent;t.subscribe(M.lobbyList,({lobbies:e})=>{this.refresh(e)}),t.subscribe(M.joinSuccess,({lobbyID:e})=>{this.connectedLobby=e,this.leavebutton.disabled=!1,this.refresh(this.lastLobbies)}),t.subscribe(M.leaveSuccess,()=>{this.connectedLobby=null,this.hosting=!1,this.leavebutton.disabled=!0,this.startbutton.disabled=!0,this.hostbutton.disabled=!1,this.connectedLobby=null,this.refresh(this.lastLobbies)}),t.subscribe(M.newHost,({hostID:e})=>{e===w.get().getID()&&(this.hosting=!0,this.startbutton.disabled=!1,this.refresh(this.lastLobbies))}),t.subscribe(M.hostSuccess,({lobbyID:e})=>{this.hosting=!0,this.connectedLobby=e,this.leavebutton.disabled=!1,this.startbutton.disabled=!1,this.refresh(this.lastLobbies)})}show(){this.mainDiv.style.display="flex"}hide(){this.mainDiv.style.display="none"}refresh(t){this.lastLobbies=t;let e=!1;this.lobbyDiv.innerHTML="";for(const s of t){const i=document.createElement("div");i.className="lobbylist-item",i.innerHTML=`
            <div class = "lobbylist-name lobbylist-column">${s.lobbyName}</div>
            <div class = "lobbylist-host lobbylist-column">${s.host}</div>
            <div class = "lobbylist-players lobbylist-column">${`${s.playerCount} / ${s.maxPlayers}`}</div>
            <div class = "lobbylist-status lobbylist-column">${this.getStatus(s)}</div>
            `,i.dataset.lobbyID=s.lobbyID,s.lobbyID===this.selectedLobbyId&&(this.selectItem(i),e=!0),i.addEventListener("click",()=>{this.selectItem(i),this.selectedLobbyId=i.dataset.lobbyID}),this.lobbyDiv.appendChild(i)}e||(this.joinbutton.disabled=!0,this.selectedLobbyId=null)}getStatus(t){return t.lobbyID===this.connectedLobby?this.hosting?"Hosting":"Connected":t.closed?"Closed":t.playerCount===t.maxPlayers?"Full":"Open"}clearSelection(){document.querySelectorAll(".lobbylist-item").forEach(t=>t.classList.remove("selected")),this.selectedLobbyId=null,this.joinbutton.disabled=!0}selectItem(t){this.clearSelection(),t.classList.add("selected"),this.joinbutton.disabled=!1}onHost(){this.hostMenu.show(),this.clearSelection()}onLeave(){const t={type:N.leaveLobby};w.get().sendClientMessage(t)}onJoin(){if(!this.selectedLobbyId)return;const t={type:N.joinLobby,lobbyID:this.selectedLobbyId};w.get().sendClientMessage(t),this.clearSelection()}onStart(){const t={type:N.startLobby};w.get().sendClientMessage(t)}}class Be{constructor(t){r(this,"canvas");r(this,"ctx");r(this,"images",new Map);this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!1}loadImage(t){if(!this.images.has(t)){const e=new Image;e.src=t,this.images.set(t,e)}return this.images.get(t)}draw(t){const e=this.loadImage(t.imageSrc);if(!e.complete){e.onload=()=>this.draw(t);return}if(this.ctx.save(),t.flip){const s=Math.floor(t.world.x+t.world.width/2);this.ctx.translate(s,Math.floor(t.world.y)),this.ctx.scale(-1,1),this.ctx.translate(-s,-Math.floor(t.world.y))}this.ctx.translate(Math.floor(t.world.x+t.world.width/2),Math.floor(t.world.y+t.world.height/2)),this.ctx.rotate(t.angle),this.ctx.drawImage(e,Math.floor(t.source.x),Math.floor(t.source.y),Math.floor(t.source.width),Math.floor(t.source.height),-t.world.width/2,-t.world.height/2,t.world.width,t.world.height),this.ctx.restore()}drawLine(t,e,s,i,a,n,l){const c=this.loadImage(t);if(!c.complete){c.onload=()=>this.drawLine(t,e,s,i,a,n,l);return}const u=Math.floor(i-e),f=Math.floor(a-s),x=Math.hypot(u,f),T=Math.atan2(f,u);this.ctx.save(),this.ctx.translate(e,s),this.ctx.rotate(T),this.ctx.drawImage(c,l.x,l.y,l.width,l.height,0,-n/2,x,n),this.ctx.restore()}drawSquare(t,e,s){this.ctx.save(),this.ctx.fillStyle=s,this.ctx.translate(t.x+t.width/2,t.y+t.height/2),this.ctx.rotate(e),this.ctx.fillRect(-t.width/2,-t.height/2,t.width,t.height),this.ctx.restore()}clear(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}setScale(t){const e=(this.canvas.width-this.canvas.width/t)/2,s=(this.canvas.height-this.canvas.height/t)/2;this.ctx.scale(t,t),this.ctx.translate(-e,-s)}}var K=(o=>(o.Offer="Offer",o.Answer="Answer",o.Candidate="Candidate",o))(K||{});class Fe{constructor(t,e){r(this,"peerConnection");r(this,"dataChannel",null);r(this,"pendingCandidates",[]);r(this,"peerId");r(this,"socket");r(this,"messageCallback",()=>{});this.peerId=t,this.socket=e,this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),this.setupConnectionHandlers()}setupConnectionHandlers(){this.peerConnection.onicecandidate=t=>{if(t.candidate){const e={type:N.forward,to:this.peerId,msg:{type:K.Candidate,candidate:t.candidate}};this.socket.send(JSON.stringify(e))}},this.peerConnection.ondatachannel=t=>{this.dataChannel=t.channel,this.setupDataChannel()}}createDataChannel(t="game"){this.dataChannel=this.peerConnection.createDataChannel(t),this.setupDataChannel()}setupDataChannel(){this.dataChannel&&(this.dataChannel.onopen=()=>{console.log(`DataChannel with ${this.peerId} open`)},this.dataChannel.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageCallback(e.type,e.gameMessage)}catch(e){console.error("Failed to parse message:",e)}},this.dataChannel.onclose=()=>{console.log(`DataChannel with ${this.peerId} closed`)},this.dataChannel.onerror=t=>{console.error(`DataChannel error with ${this.peerId}:`,t)})}setOnMessage(t){this.messageCallback=t}async createOffer(){const t=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(t);const e={type:N.forward,to:this.peerId,msg:{type:K.Offer,offer:t}};this.socket.send(JSON.stringify(e))}async handleOffer(t){await this.peerConnection.setRemoteDescription(new RTCSessionDescription(t));const e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e);const s={type:N.forward,to:this.peerId,msg:{type:K.Answer,answer:e}};this.socket.send(JSON.stringify(s)),this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[]}async handleAnswer(t){await this.peerConnection.setRemoteDescription(new RTCSessionDescription(t))}async addIceCandidate(t){const e=new RTCIceCandidate(t);this.peerConnection.remoteDescription?await this.peerConnection.addIceCandidate(e):this.pendingCandidates.push(e)}close(){this.dataChannel&&this.dataChannel.close(),this.peerConnection.close()}sendMessage(t,e){var s;((s=this.dataChannel)==null?void 0:s.readyState)==="open"&&this.peerConnection.connectionState==="connected"&&this.dataChannel.send(JSON.stringify({type:t,gameMessage:e}))}}class Ee{constructor(t){r(this,"gameEvent",new Lt);r(this,"serverEvent",new Lt);r(this,"peers",new Map);r(this,"myID");r(this,"socket");r(this,"host",!1);this.socket=t,this.socket.onmessage=e=>this.handleMessage(e),this.socket.onopen=()=>{console.log("Connected to signaling server");const e={type:N.connect},s={type:N.listLobbies};this.socket.send(JSON.stringify(e)),this.socket.send(JSON.stringify(s))}}isHost(){return this.host}getID(){return this.myID}cleanupAllPeers(){console.log("Cleaning up all peer connections"),this.peers.forEach((t,e)=>{console.log(`Closing connection to peer: ${e}`),t.close()}),this.peers.clear()}addPeer(t){if(t===this.myID||this.peers.has(t))return;console.log(`Creating new peer connection to: ${t}`);const e=new Fe(t,this.socket);this.peers.set(t,e),e.setOnMessage((i,a)=>{console.log("Received message "+y[i]+":",a),this.gameEvent.publish(i,a)}),t<this.myID&&(console.log(`Initiating connection to ${t}`),e.createDataChannel(),e.createOffer())}removePeer(t){const e=this.peers.get(t);e==null||e.close(),this.peers.delete(t)}handleForwardedMessage(t){var e,s;switch(t.msg.type){case K.Offer:console.log(`Received offer from ${t.from}`),this.peers.has(t.from)||this.addPeer(t.from),this.peers.get(t.from).handleOffer(t.msg.offer);break;case K.Answer:console.log(`Received answer from ${t.from}`),(e=this.peers.get(t.from))==null||e.handleAnswer(t.msg.answer);break;case K.Candidate:(s=this.peers.get(t.from))==null||s.addIceCandidate(t.msg.candidate);break}}handleMessage(t){const e=JSON.parse(t.data),s=e.type;switch(this.serverEvent.publish(s,e.msg),s){case M.forwarded:{const i=e.msg;this.handleForwardedMessage(i);break}case M.connected:{const i=e.msg;this.myID=i.clientID;break}case M.userJoined:{const i=e.msg;console.log(`New user joined: ${i.userID}`),this.addPeer(i.userID);break}case M.userLeft:{const i=e.msg;console.log(`User left: ${i.userID}`),this.removePeer(i.userID);break}case M.userList:{const i=e.msg;console.log("Here are all other users:",i.users);for(const a of i.users)this.addPeer(a);break}case M.lobbyList:{console.log("Got a new lobby-list");break}case M.joinSuccess:{console.log(`Joined lobby: ${e.lobbyID}`);const i={type:N.listUsers};this.socket.send(JSON.stringify(i));break}case M.leaveSuccess:{console.log("Left lobby"),this.cleanupAllPeers(),this.host=!1;break}case M.hostSuccess:{console.log(`Hosted lobby: ${e.lobbyID}`),this.host=!0;break}case M.newHost:{console.log(`New host: ${e.hostID}`),e.hostID===this.myID&&(this.host=!0,console.log("You are host"));break}case M.startGame:{console.log("Starting game");break}}}sendGameMessage(t,e){this.peers.forEach(s=>{s.sendMessage(t,e)})}sendClientMessage(t){this.socket.send(JSON.stringify(t))}connectionCount(){return this.peers.size}}class Oe{constructor(t,e,s){r(this,"table");r(this,"lipLeft");r(this,"lipRight");this.table=t,this.lipLeft=e,this.lipRight=s}tile(t){const e=this.table[t];return e||new j}getLip(t){return t===D.Left?this.lipLeft:this.lipRight}}const Z=class Z{constructor(t,e){r(this,"body");r(this,"spriteIndex",0);r(this,"sprite");this.body=new fe(t,e,!1)}getNeighbours(){return{top:this.body.isNeighbour(m.Top),right:this.body.isNeighbour(m.Right),left:this.body.isNeighbour(m.Left),bot:this.body.isNeighbour(m.Bot),topRight:this.body.isNeighbour(m.TopRight),topLeft:this.body.isNeighbour(m.TopLeft),botRight:this.body.isNeighbour(m.BotRight),botLeft:this.body.isNeighbour(m.BotLeft)}}setSpriteIndex(){this.spriteIndex=0;const{top:t,right:e,bot:s,left:i,topLeft:a,topRight:n,botLeft:l,botRight:c}=this.getNeighbours();t&&(this.spriteIndex+=1),e&&(this.spriteIndex+=2),s&&(this.spriteIndex+=4),i&&(this.spriteIndex+=8),e&&t&&n&&(this.spriteIndex+=16),i&&t&&a&&(this.spriteIndex+=32),e&&s&&c&&(this.spriteIndex+=64),i&&s&&l&&(this.spriteIndex+=128)}setLip(){const{top:t,right:e,bot:s,left:i,topLeft:a,topRight:n,botLeft:l,botRight:c}=this.getNeighbours();let u=!1,f=!1;t||(i||(u=!0),e||(f=!0)),t&&s&&(c&&e&&!n&&!i&&(u=!0),l&&i&&!a&&!e&&(f=!0)),this.body.setLip(D.Left,u),this.body.setLip(D.Right,f)}update(){this.setSpriteIndex(),this.setLip()}draw(){this.sprite.draw(Z.lookup.tile(this.spriteIndex),this.body.pos,32,!1,0),this.body.getLip(D.Left)&&this.sprite.draw(Z.lookup.getLip(D.Left),this.body.getLipDrawPos(D.Left),32,!1,0),this.body.getLip(D.Right)&&this.sprite.draw(Z.lookup.getLip(D.Right),this.body.getLipDrawPos(D.Right),32,!1,0)}};r(Z,"lookup",(()=>{const t=d.File.getTileLookup();return new Oe(t.tiles,t.lipLeft,t.lipRight)})());let wt=Z;class G extends wt{constructor(t,e){super(t,e);const s=d.File.getImage(J.tileIce);this.sprite=new z(s.src,s.frameWidth,s.frameHeight)}}const S=new Pe;S.fillArea(G,5,14,25,2);S.fillArea(G,23,5,6,8);S.fillArea(G,3,8,2,8);S.fillArea(G,9,11,2,4);S.fillArea(G,9,5,2,4);S.fillArea(G,15,7,3,3);S.setPlayerSpawn(new h(8,14));S.setPlayerSpawn(new h(15,14));S.setPlayerSpawn(new h(15,5));S.setPlayerSpawn(new h(16,14));S.setTile(G,new h(15,6));S.setItem("chestplate",new h(12,13));S.setItem("chestplate",new h(14,13));S.setItem("helmet",new h(12,14));S.setItem("shotgun",new h(10,3));S.setItem("shotgun",new h(20,14));S.setItem("glock",new h(21,12));S.setItem("grenade",new h(19,12));var V=(o=>(o[o.Loaded=0]="Loaded",o[o.Reloadable=1]="Reloadable",o[o.Empty=2]="Empty",o))(V||{});class kt{constructor(){r(this,"knockback",new h);r(this,"bulletAngleVariation",0);r(this,"pipeOffset",new h);r(this,"ammo",10);r(this,"bulletCount",1);r(this,"projectile")}shoot(t,e,s,i,a){const n=new ge(i);if(this.ammo<1)return[];const l=s?-1:1;this.ammo-=1;const c=d.Angle.rotateForce(this.pipeOffset,e),u=new h(t.x+c.x*l,t.y+c.y);for(let f=0;f<this.bulletCount;f++){let x=e+n.getInRange(-this.bulletAngleVariation,this.bulletAngleVariation);x=s?Math.PI-x:x,H.create(this.projectile,u,x,a)}return[{type:U.Knockback,value:this.getKnockback(e,s)}]}getKnockback(t,e){const s=d.Angle.rotateForce(new h(this.knockback.x,0),t);return e&&(s.x*=-1),t===0&&(s.y+=this.knockback.y),s}}class ht{constructor(t,e,s){r(this,"interactions",new Map);r(this,"ownership",k.None);r(this,"body");r(this,"localAngle",0);r(this,"worldAngle",0);r(this,"rotateSpeed",0);r(this,"rotateLerp",new Mt(15,Ft));r(this,"holdOffset",new h);r(this,"handOffset",new h);r(this,"delete",!1);this.body=new ot(t,e,s)}update(t){this.ownership===k.None?this.updateItemPhysics(t):this.body.setNewCollidableObjects()}updateItemPhysics(t){this.body.friction=this.body.grounded?5:1,this.updateAngle(t),this.body.update(t),this.body.collidingSide&&(this.rotateSpeed*=.5)}updateAngle(t){const e=this.worldAngle+this.localAngle,s=d.Angle.normalizeAngle(e);if(this.body.grounded&&s!==0&&s!==-Math.PI&&(this.rotateSpeed=0,!this.rotateLerp.isActive())){const i=Math.abs(s)>Math.PI/2?Math.PI:0;this.rotateLerp.startLerp(s,i)}this.rotateLerp.isActive()&&(this.worldAngle=this.rotateLerp.update(t)),this.worldAngle+=this.rotateSpeed*t}getBody(){return this.body}getAngle(){return this.worldAngle+this.localAngle}setWorldAngle(t){this.worldAngle=t}getHandOffset(){return this.handOffset}getHoldOffset(){return this.holdOffset}setOwnership(t){this.ownership=t}getOwnership(){return this.ownership}getDrawPos(t){return new h(this.body.pos.x+(this.body.width-t)/2,this.body.pos.y+(this.body.height-t)/2)}throw(t){this.body.grounded=!1;const e=this.body.getDirectionMultiplier();switch(t){case R.Light:{this.body.velocity=new h(210*e,-210),this.rotateSpeed=10;break}case R.Hard:{this.body.velocity=new h(900*e,-300),this.rotateSpeed=15;break}case R.HardDiagonal:{this.body.velocity=new h(900*e,-600),this.rotateSpeed=15;break}case R.Drop:{this.body.velocity=new h(0*e,0),this.rotateSpeed=5;break}case R.Upwards:{this.body.velocity=new h(0*e,-600),this.rotateSpeed=8;break}}}shouldBeDeleted(){return this.delete}deleteHelper(){return this.ownership===k.None&&Math.abs(this.body.velocity.x)<50&&this.body.grounded}setToDelete(){this.delete=!0}}class je extends ht{constructor(e){super(e,30,15);r(this,"handleOffset",0);r(this,"maxHandleOffset",-8);r(this,"handleLerp",new Mt(6,Et));r(this,"frames",{gun:new j,handle:new j});r(this,"currentState",V.Loaded);r(this,"spriteSheet");r(this,"firearmInfo");this.holdOffset=new h(14,-4),this.handOffset=new h(4,0);const a=d.File.getImage(J.shotgun);this.spriteSheet=new z(a.src,a.frameWidth,a.frameHeight),d.File.setFrames("shotgun",this.frames),this.setupFirearmInfo(),this.interactions.set(B.Activate,(n,l)=>this.shoot(n,l))}setupFirearmInfo(){this.firearmInfo=new kt,this.firearmInfo.projectile="shotgunBullet",this.firearmInfo.ammo=2,this.firearmInfo.bulletCount=10,this.firearmInfo.bulletAngleVariation=Math.PI/12,this.firearmInfo.pipeOffset=new h(28,-10),this.firearmInfo.knockback=new h(720,240)}update(e){super.update(e),this.handleLerp.isActive()&&(this.handleOffset=this.handleLerp.update(e))}shoot(e,s){return this.currentState===V.Loaded?this.fire(e,s):this.currentState===V.Reloadable?this.reload():[]}fire(e,s){return this.handleLerp.cancel(),this.handleOffset=0,this.currentState=V.Reloadable,this.firearmInfo.shoot(this.body.getCenter(),this.getAngle(),this.body.isFlip(),e,s)}reload(){return this.handleLerp.startLerp(0,this.maxHandleOffset),this.currentState=this.firearmInfo.ammo===0?V.Empty:V.Loaded,[]}draw(){const s=this.getDrawPos(64);this.spriteSheet.draw(this.frames.gun,s,64,this.body.isFlip(),this.getAngle());const i=d.Angle.rotateForce(new h(this.handleOffset,0),this.getAngle()),a=new h(s.x+i.x*this.body.getDirectionMultiplier(),s.y+i.y);this.spriteSheet.draw(this.frames.handle,a,64,this.body.isFlip(),this.getAngle())}shouldBeDeleted(){return super.shouldBeDeleted()||this.deleteHelper()&&this.currentState===V.Empty}}class Te extends ht{constructor(e){super(e,30,15);r(this,"animations",{default:new E,shoot:new E});r(this,"animator");r(this,"firearmInfo");this.handOffset=new h(2,2),this.holdOffset=new h(10,-4);const a=d.File.getImage(J.glock);d.File.setAnimations("glock",this.animations),this.animator=new ct(new z(a.src,a.frameWidth,a.frameHeight),this.animations.default),this.setupFirearmInfo(),this.interactions.set(B.Activate,(n,l)=>this.shoot(n,l))}setupFirearmInfo(){this.firearmInfo=new kt,this.firearmInfo.ammo=9,this.firearmInfo.bulletAngleVariation=Math.PI/36,this.firearmInfo.knockback=new h(450,120),this.firearmInfo.pipeOffset=new h(20,-6),this.firearmInfo.projectile="glockBullet"}update(e){super.update(e),this.animator.update(e),this.animator.animationDone()&&this.animator.setAnimation(this.animations.default)}shoot(e,s){return this.animator.reset(),this.animator.setAnimation(this.animations.shoot),this.firearmInfo.shoot(this.body.getCenter(),this.getAngle(),this.body.isFlip(),e,s)}draw(){this.animator.draw(this.getDrawPos(40),40,this.body.isFlip(),this.getAngle())}shouldBeDeleted(){return super.shouldBeDeleted()||this.deleteHelper()&&this.firearmInfo.ammo===0}}class Ne{constructor(t,e,s){r(this,"pos");r(this,"scale");r(this,"angle",0);r(this,"drawSize",128);r(this,"animator");r(this,"animations",{animation:new E});r(this,"setToDelete",!1);this.pos=t,this.scale=s,this.angle=e;const i=d.File.getImage(J.explosion);this.animator=new ct(new z(i.src,i.frameWidth,i.frameHeight),this.animations.animation),d.File.setAnimations("explosive",this.animations)}update(t){this.pos.y-=5*t,this.angle+=.1*t,this.animator.update(t),this.animator.animationDone()&&(this.setToDelete=!0)}getDrawPos(){return this.pos.clone().subtract(this.drawSize/2)}draw(){this.animator.draw(this.getDrawPos(),this.drawSize*this.scale,!1,this.angle)}}class qe{constructor(t){r(this,"particles",new Set);r(this,"particleSpawnLocations");r(this,"nextParticleCountdown",new $(.01));r(this,"amountOfAddedParticles",0);r(this,"order");this.particleSpawnLocations=d.Vector.getPointsAroundCircle(t,50,8),d.Vector.randomOffsetVectorArray(this.particleSpawnLocations,7),this.particleSpawnLocations.push(t.clone()),this.order=d.Random.getRandomArray(9),this.nextParticleCountdown.setToReady()}update(t){for(const e of this.particles.values())e.update(t),e.setToDelete&&this.particles.delete(e);if(this.nextParticleCountdown.update(t),this.nextParticleCountdown.isDone()&&this.amountOfAddedParticles<this.particleSpawnLocations.length){const e=this.order[this.amountOfAddedParticles],s=this.particleSpawnLocations[e],i=d.Random.getRandomNumber(-Math.PI,Math.PI),a=d.Random.getRandomNumber(.7,1.2);this.particles.add(new Ne(s,i,a)),this.amountOfAddedParticles+=1,this.nextParticleCountdown.reset()}}draw(){for(const t of this.particles.values())t.draw()}shouldBeDeleted(){return this.particles.size===0}}class ze extends ht{constructor(e){super(e,8,19);r(this,"spriteSheet");r(this,"drawSize",32);r(this,"frames",{pinned:new j,default:new j});r(this,"explosionDelay",new $(2));r(this,"activated",!1);r(this,"locallyActivated");const a=d.File.getImage(J.grenade);this.spriteSheet=new z(a.src,a.frameWidth,a.frameHeight),d.File.setFrames("grenade",this.frames),this.holdOffset=new h(11,-6),this.body.bounceFactor=.3,this.interactions.set(B.Activate,(n,l)=>(this.activate(),this.locallyActivated=l,[]))}update(e){if(this.activated&&this.explosionDelay.update(e),super.update(e),this.explosionDelay.isDone()){ft.addParticle(new qe(this.body.getCenter())),this.setToDelete();const s=16;for(let i=0;i<s;i++){const a=i*2*Math.PI/s,n=this.body.pos;H.create("grenadeBullet",n,a,this.locallyActivated)}}}activate(){this.activated=!0}draw(){const e=this.activated?this.frames.pinned:this.frames.default;this.spriteSheet.draw(e,this.getDrawPos(this.drawSize),this.drawSize,this.body.isFlip(),this.getAngle())}}const yt=class yt extends ht{constructor(e){super(e,20,20);r(this,"frames",{default:new j,equipped:new j});r(this,"spriteSheet");const a=d.File.getImage(J.armor);this.spriteSheet=new z(a.src,a.frameWidth,a.frameHeight),d.File.setFrames("chestplate",this.frames),this.interactions.set(B.Activate,()=>(this.setOwnership(k.Equipped),[{type:U.Equip,value:yt.slot}])),this.interactions.set(B.Hit,(n,l)=>this.getOwnership()===k.Equipped?this.onHitFunction(n,l):[])}draw(){const e=this.getOwnership()===k.Equipped?this.frames.equipped:this.frames.default,s=32;this.spriteSheet.draw(e,this.getDrawPos(s),s,this.body.isFlip(),this.getAngle())}onHitFunction(e,s){return this.setToDelete(),[]}};r(yt,"slot",p.Body);let bt=yt;const mt=class mt extends ht{constructor(e){super(e,32,32);r(this,"frames",{default:new j,broken:new j});r(this,"spriteSheet");r(this,"damaged",!1);const a=d.File.getImage(J.armor);this.spriteSheet=new z(a.src,a.frameWidth,a.frameHeight),d.File.setFrames("helmet",this.frames),this.interactions.set(B.Activate,()=>(this.setOwnership(k.Equipped),[{type:U.Equip,value:mt.slot}])),this.interactions.set(B.Hit,(n,l)=>this.getOwnership()===k.Equipped?this.onHitFunction(n,l):[])}draw(){const e=this.damaged?this.frames.broken:this.frames.default,s=32;this.spriteSheet.draw(e,this.getDrawPos(s),s,this.body.isFlip(),this.getAngle())}onHitFunction(e,s){return this.setToDelete(),[]}};r(mt,"slot",p.Head);let Ct=mt;class Je{constructor(t,e,s,i){r(this,"spriteSheet");r(this,"startingLocation");r(this,"target");r(this,"maxLength");r(this,"size");r(this,"speed");r(this,"removing",!1);r(this,"setToRemove",!1);r(this,"frames",{default:new j});const a=d.File.getImage(J.trail);this.spriteSheet=new z(a.src,a.frameWidth,a.frameHeight),this.startingLocation=t,this.maxLength=s,this.size=i,this.speed=e,d.File.setFrames("trail",this.frames)}update(t){this.removing&&this.removeUpdate(t)}removeUpdate(t){const e=this.startingLocation.x+this.speed.x*t,s=this.startingLocation.y+this.speed.y*t,i=this.speed.x>0,a=this.speed.y>0,n=i?e>this.target.x:e<this.target.x,l=a?s>this.target.y:s<this.target.y;n||l?this.setToRemove=!0:this.startingLocation=new h(e,s)}setTarget(t){const e=t.x-this.startingLocation.x,s=t.y-this.startingLocation.y,i=Math.hypot(e,s);if(i>this.maxLength){const a=this.maxLength/i;this.startingLocation=new h(t.x-e*a,t.y-s*a)}this.target=t}setToDelete(){this.removing=!0}shouldBeDeleted(){return this.setToRemove}draw(){this.spriteSheet.drawLine(this.frames.default,this.startingLocation,this.target,this.size)}}class It{constructor(t,e,s,i){r(this,"angle");r(this,"lifespan");r(this,"trail");r(this,"delete",!1);r(this,"local",!1);r(this,"pos");r(this,"velocity");r(this,"delay",!0);const a=d.Angle.rotateForce(new h(s,0),e),n=2;this.lifespan=new $(i),this.pos=t,this.velocity=a,this.angle=Math.atan2(a.y,a.x);const l=100,c=t.clone().add(n/2);this.trail=new Je(c,a.clone(),l,n),this.trail.setTarget(c)}getTrail(){return this.trail}update(t){if(this.delay){this.delay=!1;return}const e=this.pos.clone().add(this.velocity.clone().multiply(t));tt.getNearbyTiles(this.pos,1,1,e).forEach(i=>{if(i.platform&&i.gameObject.pos.y>this.pos.y)return;this.willGoThrough(i.gameObject,t).collision&&this.setToDelete()}),this.pos=e,this.lifespan.update(t)}willGoThrough(t,e){const s=this.pos,i=s.clone().add(this.velocity.clone().multiply(e));return t.lineCollision(s,i)}getPos(){return this.pos}setPos(t){this.pos=t}setToDelete(){this.delete=!0}shouldBeDeleted(){return this.delete||this.lifespan.isDone()}isLocal(){return this.local}setLocal(){this.local=!0}onPlayerHit(){return this.setToDelete(),xt.Damage}draw(){}}class Ue extends It{constructor(t,e){super(t,e,2e3,.07)}}class We extends It{constructor(t,e){super(t,e,2200,.14)}}class Ve extends It{constructor(t,e){super(t,e,2e3,.08)}}function $e(){v.registerItem("shotgun",je),v.registerItem("glock",Te),v.registerItem("grenade",ze),v.registerItem("chestplate",bt),v.registerItem("helmet",Ct),H.registerProjectile("glockBullet",We),H.registerProjectile("shotgunBullet",Ue),H.registerProjectile("grenadeBullet",Ve)}I.init();_.set(new Be("gameCanvas"));ut.addMap("defaultMap",S);$e();w.set(new Ee(new WebSocket("ws://localhost:3000")));dt.set(new Re);new ke;
